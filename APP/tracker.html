<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker Wydatków</title>
    <meta name="description" content="Aplikacja do śledzenia wydatków z inteligentną analizą paragonów.">
    <meta name="theme-color" content="#4F46E5"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.svg">
    <style>
        .nav-btn {
            border-bottom: 4px solid transparent;
            transition: border-color 0.3s, color 0.3s;
        }
        .nav-btn.active {
            border-bottom-color: #4F46E5;
            color: #4F46E5;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .category-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            margin-right: 4px;
            margin-bottom: 4px;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loading-section" class="min-h-screen flex flex-col items-center justify-center bg-gray-100">
        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600"></div>
        <p class="mt-4 text-lg text-gray-600">Wczytuję aplikację...</p>
    </div>

    <div id="auth-section" class="hidden min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <h2 id="auth-title" class="mt-6 text-center text-3xl font-extrabold text-gray-900">Zaloguj się do swojego konta</h2>
            </div>
            <form id="login-form" class="mt-8 space-y-6" action="#" method="POST">
                <input type="hidden" name="remember" value="true">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div><input id="login-email" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Adres email"></div>
                    <div><input id="login-password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Hasło"></div>
                </div>
                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50">
                        <span class="button-text">Zaloguj się</span>
                        <span class="button-spinner hidden absolute right-4 top-1/2 -translate-y-1/2">
                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                    </button>
                </div>
            </form>
            <form id="register-form" class="mt-8 space-y-6 hidden" action="#" method="POST">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div><input id="register-email" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Adres email"></div>
                    <div><input id="register-password" name="password" type="password" autocomplete="new-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Hasło"></div>
                </div>
                <div><button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Zarejestruj się</button></div>
            </form>
            <div class="text-center">
                <a href="#" id="switch-auth-link" class="font-medium text-indigo-600 hover:text-indigo-500">Nie masz konta? Zarejestruj się</a>
            </div>
            <div id="auth-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert"></div>
        </div>
    </div>

    <div id="app-section" class="hidden">
        <header class="bg-white shadow">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
                <h1 class="text-2xl font-bold text-gray-900">Tracker Wydatków</h1>
                <div class="flex items-center">
                    <div id="monthly-balance" class="text-right mr-4">
                        <p id="monthly-balance-label" class="text-sm text-gray-500">Wydatki w tym miesiącu</p>
                        <p id="monthly-balance-value" class="text-lg font-bold text-indigo-600">0.00 zł</p>
                    </div>
                    <button id="logout-btn" class="p-2 text-gray-500 hover:text-red-600" title="Wyloguj"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg></button>
                </div>
            </div>
        </header>

        <main class="max-w-4xl mx-auto py-6 sm:px-6 lg:px-8">
            <nav class="bg-white rounded-lg shadow mb-6">
                <div class="flex -mb-px">
                    <button data-tab="add" class="nav-btn py-4 px-6">Dodaj Zakup</button>
                    <button data-tab="list" class="nav-btn py-4 px-6">Lista Zakupów</button>
                    <button data-tab="categories" class="nav-btn py-4 px-6">Kategorie</button>
                    <button data-tab="stats" class="nav-btn py-4 px-6">Statystyki</button>
                </div>
            </nav>

            <div id="add-tab" class="tab-content">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Dodaj paragon skanując go</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                        <div>
                            <input type="file" id="receipt-file-input" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="analyze-receipt-btn" class="w-full py-2 px-4 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 whitespace-nowrap">Analizuj paragon</button>
                            <button id="start-camera-btn" class="w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 whitespace-nowrap">Użyj aparatu</button>
                        </div>
                    </div>
                    <div id="image-preview-container" class="hidden mt-4">
                        <img id="image-preview" class="max-h-48 mx-auto rounded-lg" />
                    </div>
                    <div id="analysis-spinner" class="hidden text-center mt-4">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div>
                        <p class="text-gray-600">Analizuję dane z paragonu, proszę czekać...</p>
                    </div>
                    <div id="camera-view" class="hidden mt-4">
                        <video id="camera-stream" class="w-full rounded-lg" autoplay></video>
                        <div class="flex items-center space-x-2 mt-2">
                            <button id="capture-photo-btn" class="w-full py-2 px-4 bg-green-600 text-white rounded-md hover:bg-green-700">Zrób zdjęcie</button>
                            <button id="cancel-camera-btn" class="w-full py-2 px-4 bg-gray-500 text-white rounded-md hover:bg-gray-600">Anuluj</button>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h3 id="purchase-form-title" class="text-lg font-semibold mb-4">Dodaj nowy zakup ręcznie</h3>
                    <form id="purchase-form">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="shop" class="block text-sm font-medium text-gray-700">Sklep</label>
                                <input type="text" id="shop" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="date" class="block text-sm font-medium text-gray-700">Data</label>
                                <input type="date" id="date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div id="total-amount-container" class="hidden">
                                <label class="block text-sm font-medium text-gray-700">Suma</label>
                                <p id="total-amount-value" class="mt-1 text-xl font-bold text-gray-900">0.00 zł</p>
                            </div>
                        </div>
                        <div class="border-t border-gray-200 pt-4">
                            <h4 class="text-md font-medium text-gray-800 mb-2">Pozycje na paragonie</h4>
                            <div id="items-container" class="space-y-2"></div>
                            <div class="flex justify-between items-center mt-4">
                                <button type="button" id="add-item-btn" class="py-2 px-4 bg-blue-500 text-white rounded-md hover:bg-blue-600">Dodaj pozycję</button>
                                <div>
                                    <button type="button" id="cancel-edit-btn" class="py-2 px-4 bg-gray-500 text-white rounded-md hover:bg-gray-600 mr-2 hidden">Anuluj</button>
                                    <button type="submit" class="py-2 px-4 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Zapisz cały zakup</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div id="list-tab" class="tab-content"><div id="purchases-list" class="space-y-4"></div></div>
            
            <div id="categories-tab" class="tab-content hidden bg-white rounded-lg shadow p-6">
                 <h3 class="text-lg font-semibold mb-4">Zarządzaj Kategoriami</h3>
                 <div id="categories-list" class="space-y-2"></div>
            </div>

            <div id="stats-tab" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="stats-title" class="text-lg font-semibold">Statystyki wydatków</h3>
                        <select id="stats-month-select" class="block w-52 rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></select>
                    </div>
                    <div id="category-chart-container">
                        <canvas id="category-chart"></canvas>
                    </div>
                    <div id="no-data-pie-chart" class="hidden text-center py-12">
                        <p class="text-gray-500">Brak danych o wydatkach w wybranym miesiącu.</p>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Porównanie wydatków w ostatnich miesiącach</h3>
                    <div id="comparison-chart-container">
                        <canvas id="comparison-chart"></canvas>
                    </div>
                    <div id="no-data-bar-chart" class="hidden text-center py-12">
                        <p class="text-gray-500">Brak historii wydatków do porównania.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
    // --- Konfiguracja ---
    const API_BASE_URL = 'https://tracker-wydatkow-backend.onrender.com'; // Używamy ścieżek względnych

    // --- Stan Aplikacji ---
    let allPurchases = [];
    let allCategories = [];
    let editMode = { active: false, purchaseId: null };
    let currentFile = null;
    let cameraStream = null;
    let categoryChart = null;
    let comparisonChart = null;

    // --- Elementy DOM ---
    const loadingSection = document.getElementById('loading-section');
    const authSection = document.getElementById('auth-section');
    const appSection = document.getElementById('app-section');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const loginEmail = document.getElementById('login-email');
    const loginPassword = document.getElementById('login-password');
    const registerEmail = document.getElementById('register-email');
    const registerPassword = document.getElementById('register-password');
    const authTitle = document.getElementById('auth-title');
    const switchAuthLink = document.getElementById('switch-auth-link');
    const authErrorDiv = document.getElementById('auth-error');
    const logoutBtn = document.getElementById('logout-btn');
    const navBtns = document.querySelectorAll('.nav-btn');
    const purchaseForm = document.getElementById('purchase-form');
    const purchaseFormTitle = document.getElementById('purchase-form-title');
    const purchaseFormSubmitBtn = purchaseForm.querySelector('button[type="submit"]');
    const addItemBtn = document.getElementById('add-item-btn');
    const purchasesList = document.getElementById('purchases-list');
    const itemsContainer = document.getElementById('items-container');
    const shopInput = document.getElementById('shop');
    const dateInput = document.getElementById('date');
    const categoriesList = document.getElementById('categories-list');
    const monthlyBalanceValue = document.getElementById('monthly-balance-value');
    const monthlyBalanceLabel = document.getElementById('monthly-balance-label');
    const receiptFileInput = document.getElementById('receipt-file-input');
    const analyzeReceiptBtn = document.getElementById('analyze-receipt-btn');
    const analysisSpinner = document.getElementById('analysis-spinner');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const startCameraBtn = document.getElementById('start-camera-btn');
    const cameraView = document.getElementById('camera-view');
    const cameraStreamEl = document.getElementById('camera-stream');
    const capturePhotoBtn = document.getElementById('capture-photo-btn');
    const cancelCameraBtn = document.getElementById('cancel-camera-btn');
    const totalAmountContainer = document.getElementById('total-amount-container');
    const totalAmountValue = document.getElementById('total-amount-value');
    const statsTitle = document.getElementById('stats-title');
    const statsMonthSelect = document.getElementById('stats-month-select');
    const categoryChartContainer = document.getElementById('category-chart-container');
    const noDataPieChart = document.getElementById('no-data-pie-chart');
    const comparisonChartContainer = document.getElementById('comparison-chart-container');
    const noDataBarChart = document.getElementById('no-data-bar-chart');

    // --- Funkcje Pomocnicze ---
    const categoryColors = {};
    const colorPalette = ['#3b82f6', '#10b981', '#ef4444', '#f97316', '#8b5cf6', '#ec4899', '#f59e0b', '#14b8a6', '#64748b', '#06b6d4'];
    let colorIndex = 0;

    function getCategoryColor(category) {
        if (!categoryColors[category]) {
            categoryColors[category] = colorPalette[colorIndex % colorPalette.length];
            colorIndex++;
        }
        return categoryColors[category];
    }

    // --- Funkcja do komunikacji z API ---
    async function apiCall(endpoint, method = 'GET', body = null) {
        const token = localStorage.getItem('authToken');
        const headers = { 'Content-Type': 'application/json' };
        if (token) {
            headers['X-Auth-Token'] = token;
        }
        const options = { method, headers };
        if (body) options.body = JSON.stringify(body);

        const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
        if (response.status === 401 && endpoint !== '/auth/status') {
            logout();
            throw new Error('Sesja wygasła. Zaloguj się ponownie.');
        }
        const text = await response.text();
        const data = text ? JSON.parse(text) : {};
        if (!response.ok) throw new Error(data.error || 'Błąd serwera');
        return data;
    }

    async function apiCallWithFile(endpoint, file) {
        const token = localStorage.getItem('authToken');
        const formData = new FormData();
        formData.append('image', file);

        const response = await fetch(`${API_BASE_URL}${endpoint}`, {
            method: 'POST',
            headers: { 'X-Auth-Token': token },
            body: formData
        });
        if (response.status === 401) {
            logout();
            throw new Error('Sesja wygasła. Zaloguj się ponownie.');
        }
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Błąd serwera');
        return data;
    }

    // --- Logika Uwierzytelniania ---
    function setupAuthEventListeners() {
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authErrorDiv.classList.add('hidden');
            
            const submitButton = loginForm.querySelector('button[type="submit"]');
            const buttonText = submitButton.querySelector('.button-text');
            const buttonSpinner = submitButton.querySelector('.button-spinner');

            submitButton.disabled = true;
            buttonText.classList.add('invisible');
            buttonSpinner.classList.remove('hidden');

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: loginEmail.value, password: loginPassword.value })
                });
                const data = await response.json();
                if (!response.ok || !data.success) throw new Error(data.error || 'Błąd logowania');
                localStorage.setItem('authToken', data.token);
                await initializeApp();
            } catch (error) {
                authErrorDiv.textContent = error.message;
                authErrorDiv.classList.remove('hidden');
            } finally {
                submitButton.disabled = false;
                buttonText.classList.remove('invisible');
                buttonSpinner.classList.add('hidden');
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authErrorDiv.classList.add('hidden');
            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: registerEmail.value, password: registerPassword.value })
                });
                const data = await response.json();
                if (!response.ok || !data.success) throw new Error(data.error || 'Błąd rejestracji');
                alert('Rejestracja pomyślna! Możesz się teraz zalogować.');
                switchAuthForm('login');
            } catch (error) {
                authErrorDiv.textContent = error.message;
                authErrorDiv.classList.remove('hidden');
            }
        });

        switchAuthLink.addEventListener('click', (e) => {
            e.preventDefault();
            const isLogin = !loginForm.classList.contains('hidden');
            switchAuthForm(isLogin ? 'register' : 'login');
        });

        logoutBtn.addEventListener('click', logout);
    }

    function switchAuthForm(form) {
        if (form === 'login') {
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            authTitle.textContent = 'Zaloguj się do swojego konta';
            switchAuthLink.textContent = 'Nie masz konta? Zarejestruj się';
        } else {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            authTitle.textContent = 'Stwórz nowe konto';
            switchAuthLink.textContent = 'Masz już konto? Zaloguj się';
        }
    }

    function logout() {
        localStorage.removeItem('authToken');
        appSection.classList.add('hidden');
        authSection.classList.remove('hidden');
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
        }
    }

    // --- Główna Logika Aplikacji ---
    function setupAppEventListeners() {
        navBtns.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
        purchaseForm.addEventListener('submit', handlePurchaseFormSubmit);
        addItemBtn.addEventListener('click', () => addItemRow());
        document.getElementById('cancel-edit-btn').addEventListener('click', () => {
            exitEditMode();
            switchTab('list');
        });

        purchasesList.addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.edit-purchase-btn');
            if (editBtn) {
                const purchaseId = e.target.closest('[data-purchase-id]').dataset.purchaseId;
                enterEditMode(purchaseId);
                return;
            }

            const deleteBtn = e.target.closest('.delete-purchase-btn');
            if (deleteBtn) {
                const purchaseId = e.target.closest('[data-purchase-id]').dataset.purchaseId;
                if (confirm('Czy na pewno chcesz usunąć ten zakup? Operacja jest nieodwracalna.')) {
                    try {
                        await apiCall(`/api/purchases/${purchaseId}`, 'DELETE');
                        await fetchInitialData();
                    } catch (error) {
                        alert('Nie udało się usunąć zakupu: ' + error.message);
                    }
                }
                return;
            }
            
            const header = e.target.closest('.purchase-header');
            if (header) {
                const itemsDiv = header.nextElementSibling;
                itemsDiv.classList.toggle('hidden');
            }
        });

        categoriesList.addEventListener('click', handleCategoryActions);
        analyzeReceiptBtn.addEventListener('click', handleAnalyzeReceipt);
        receiptFileInput.addEventListener('change', handleFileSelect);
        startCameraBtn.addEventListener('click', startCamera);
        cancelCameraBtn.addEventListener('click', stopCamera);
        capturePhotoBtn.addEventListener('click', capturePhoto);
        statsMonthSelect.addEventListener('change', updateCategoryPieChart);
    }

    function switchTab(tabName) {
        navBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabName));
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.toggle('active', content.id === `${tabName}-tab`);
        });
        if (tabName !== 'add') exitEditMode();
        if (tabName === 'categories') renderCategoriesList();
        if (tabName === 'stats') renderStatistics();
    }

    async function fetchInitialData(shouldSwitchToList = true) {
        try {
            [allPurchases, allCategories] = await Promise.all([
                apiCall('/api/purchases'),
                apiCall('/api/categories')
            ]);
            renderAll();
            if (shouldSwitchToList) switchTab('list');
        } catch (error) {
            alert(error.message);
        }
    }

    function renderAll() {
        renderPurchasesList();
        updateMonthlyBalance();
    }

    function updateMonthlyBalance() {
        const now = new Date();
        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        const monthlyPurchases = allPurchases.filter(p => p.date >= firstDayOfMonth);
        const total = monthlyPurchases.reduce((sum, p) => sum + (p.totalAmount || 0), 0);
        monthlyBalanceValue.textContent = `${total.toFixed(2)} zł`;
        
        const monthName = now.toLocaleString('pl-PL', { month: 'long' });
        monthlyBalanceLabel.textContent = `Wydatki w ${monthName.charAt(0).toUpperCase() + monthName.slice(1)}`;
    }

    // --- Logika Formularza Zakupu ---
    function addItemRow(item = {}) {
        const itemRow = document.createElement('div');
        itemRow.className = 'item-row grid grid-cols-1 md:grid-cols-10 gap-2 items-center';
        
        const categoryOptions = allCategories.map(cat => `<option value="${cat}" ${item.category === cat ? 'selected' : ''}>${cat.charAt(0).toUpperCase() + cat.slice(1)}</option>`).join('');
        
        const priceValue = typeof item.price === 'number' ? item.price.toFixed(2) : '';

        itemRow.innerHTML = `
            <div class="md:col-span-4">
                <input type="text" class="item-name mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Nazwa produktu" value="${item.name || ''}" required>
            </div>
            <div class="md:col-span-2">
                <input type="number" step="0.01" class="item-price mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Cena" value="${priceValue}" required>
            </div>
            <div class="md:col-span-3">
                <select class="item-category-select mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                    <option value="">Wybierz kategorię</option>
                    ${categoryOptions}
                    <option value="__add_new__">-- Dodaj nową --</option>
                </select>
                <input type="text" class="new-category-input hidden mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Nazwa nowej kategorii">
            </div>
            <div class="md:col-span-1 text-right">
                <button type="button" class="remove-item-btn p-2 text-red-500 hover:text-red-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg></button>
            </div>
        `;
        itemsContainer.appendChild(itemRow);
        
        const categorySelect = itemRow.querySelector('.item-category-select');
        const newCategoryInput = itemRow.querySelector('.new-category-input');

        categorySelect.addEventListener('change', () => {
            if (categorySelect.value === '__add_new__') {
                categorySelect.classList.add('hidden');
                newCategoryInput.classList.remove('hidden');
                newCategoryInput.focus();
            }
        });

        newCategoryInput.addEventListener('blur', () => handleNewCategory(newCategoryInput, categorySelect));
        newCategoryInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleNewCategory(newCategoryInput, categorySelect);
            }
        });

        itemRow.querySelector('.remove-item-btn').addEventListener('click', () => itemRow.remove());
    }

    function handleNewCategory(newCategoryInput, categorySelect) {
        const newCategory = newCategoryInput.value.trim().toLowerCase();
        if (newCategory && !allCategories.includes(newCategory)) {
            allCategories.push(newCategory);
            allCategories.sort();
            updateAllCategorySelects(newCategory);
        }
        newCategoryInput.value = '';
        newCategoryInput.classList.add('hidden');
        categorySelect.classList.remove('hidden');
        if (newCategory) categorySelect.value = newCategory;
        else categorySelect.value = '';
    }

    function updateAllCategorySelects(newlySelected = null) {
        const categoryOptions = allCategories.map(cat => `<option value="${cat}">${cat.charAt(0).toUpperCase() + cat.slice(1)}</option>`).join('');
        const fullHtml = `<option value="">Wybierz kategorię</option>${categoryOptions}<option value="__add_new__">-- Dodaj nową --</option>`;
        
        document.querySelectorAll('.item-category-select').forEach(select => {
            const currentValue = select.value;
            select.innerHTML = fullHtml;
            select.value = newlySelected || currentValue;
        });
    }

    async function handlePurchaseFormSubmit(e) {
        e.preventDefault();
        const purchaseData = {
            shop: shopInput.value,
            date: dateInput.value,
            items: Array.from(document.querySelectorAll('.item-row')).map(row => {
                const name = row.querySelector('.item-name').value;
                const price = parseFloat(row.querySelector('.item-price').value.replace(',', '.'));
                let category = row.querySelector('.item-category-select').value;
                if (!category || category === '__add_new__') category = 'inne';
                return { name, price, category };
            }).filter(item => item.name && !isNaN(item.price))
        };

        if (purchaseData.items.length === 0) {
            alert('Dodaj przynajmniej jedną pozycję do zakupu.');
            return;
        }

        try {
            if (editMode.active) {
                await apiCall(`/api/purchases/${editMode.purchaseId}`, 'PUT', purchaseData);
            } else {
                await apiCall('/api/purchases', 'POST', purchaseData);
            }
            await fetchInitialData();
        } catch (error) {
            alert('Błąd zapisu: ' + error.message);
        }
    }

    function enterEditMode(purchaseId) {
        const purchase = allPurchases.find(p => p.id === purchaseId);
        if (!purchase) return;

        editMode.active = true;
        editMode.purchaseId = purchaseId;

        shopInput.value = purchase.shop;
        dateInput.value = purchase.date;
        itemsContainer.innerHTML = '';
        purchase.items.forEach(item => addItemRow(item));

        purchaseFormTitle.textContent = 'Edytuj istniejący zakup';
        purchaseFormSubmitBtn.textContent = 'Zaktualizuj zakup';
        purchaseFormSubmitBtn.classList.replace('bg-indigo-600', 'bg-green-600');
        purchaseFormSubmitBtn.classList.replace('hover:bg-indigo-700', 'hover:bg-green-700');
        document.getElementById('cancel-edit-btn').classList.remove('hidden');
        totalAmountContainer.classList.remove('hidden');
        totalAmountValue.textContent = `${(purchase.totalAmount || 0).toFixed(2)} zł`;

        switchTab('add');
    }

    function exitEditMode() {
        editMode.active = false;
        editMode.purchaseId = null;

        purchaseForm.reset();
        itemsContainer.innerHTML = '';
        dateInput.value = new Date().toISOString().split('T')[0];
        addItemRow();

        purchaseFormTitle.textContent = 'Dodaj nowy zakup ręcznie';
        purchaseFormSubmitBtn.textContent = 'Zapisz cały zakup';
        purchaseFormSubmitBtn.classList.replace('bg-green-600', 'bg-indigo-600');
        purchaseFormSubmitBtn.classList.replace('hover:bg-green-700', 'hover:bg-indigo-700');
        document.getElementById('cancel-edit-btn').classList.add('hidden');
        totalAmountContainer.classList.add('hidden');
    }

    // --- Logika Listy Zakupów ---
    function renderPurchasesList() {
        if (allPurchases.length === 0) {
            purchasesList.innerHTML = '<p class="text-center text-gray-500">Brak zapisanych zakupów. Dodaj pierwszy!</p>';
            return;
        }
        purchasesList.innerHTML = allPurchases.map(p => `
            <div class="bg-white rounded-lg shadow" data-purchase-id="${p.id}">
                <div class="purchase-header flex justify-between items-center p-4 cursor-pointer">
                    <div>
                        <p class="font-bold text-lg">${p.shop}</p>
                        <p class="text-sm text-gray-600">${p.date}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-xl">${(p.totalAmount || 0).toFixed(2)} zł</p>
                        <p class="text-xs text-gray-500">${(p.items || []).length} poz.</p>
                    </div>
                    <div class="flex items-center">
                        <button class="edit-purchase-btn p-2 text-blue-500 hover:text-blue-700" title="Edytuj"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                        <button class="delete-purchase-btn p-2 text-red-500 hover:text-red-700" title="Usuń"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                    </div>
                </div>
                <div class="purchase-items hidden border-t p-4 space-y-2">
                    ${(p.items || []).map(item => `
                        <div class="flex justify-between items-center">
                            <span>${item.name}</span>
                            <div>
                                <span class="category-tag text-white" style="background-color: ${getCategoryColor(item.category)}">${item.category}</span>
                                <span class="font-medium">${(item.price || 0).toFixed(2)} zł</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    // --- Logika Zarządzania Kategoriami ---
    function renderCategoriesList() {
        categoriesList.innerHTML = allCategories.map(cat => `
            <div class="flex justify-between items-center p-2 border-b" data-category-name="${cat}">
                <span class="category-text">${cat.charAt(0).toUpperCase() + cat.slice(1)}</span>
                <div class="category-actions">
                    <button class="rename-cat-btn p-1 text-blue-500 hover:text-blue-700" title="Zmień nazwę"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                    <button class="delete-cat-btn p-1 text-red-500 hover:text-red-700" title="Usuń"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                </div>
            </div>
        `).join('');
    }

    async function handleCategoryActions(e) {
        const renameBtn = e.target.closest('.rename-cat-btn');
        if (renameBtn) {
            const categoryDiv = e.target.closest('[data-category-name]');
            const oldName = categoryDiv.dataset.categoryName;
            const newName = prompt(`Wprowadź nową nazwę dla kategorii "${oldName}":`, oldName);
            if (newName && newName.trim() !== '' && newName !== oldName) {
                try {
                    await apiCall(`/api/categories/${oldName}`, 'PUT', { newName: newName.trim().toLowerCase() });
                    await fetchInitialData(false);
                    renderCategoriesList();
                } catch (error) {
                    alert('Nie udało się zmienić nazwy: ' + error.message);
                }
            }
        }

        const deleteBtn = e.target.closest('.delete-cat-btn');
        if (deleteBtn) {
            const categoryDiv = e.target.closest('[data-category-name]');
            const name = categoryDiv.dataset.categoryName;
            if (confirm(`Czy na pewno chcesz usunąć kategorię "${name}"? Wszystkie produkty z tą kategorią zostaną oznaczone jako "inne".`)) {
                try {
                    await apiCall(`/api/categories/${name}`, 'DELETE');
                    await fetchInitialData(false);
                    renderCategoriesList();
                } catch (error) {
                    alert('Nie udało się usunąć kategorii: ' + error.message);
                }
            }
        }
    }

    // --- Logika Skanowania i Aparatu ---
    function handleFileSelect(event) {
        currentFile = event.target.files[0];
        if (currentFile) {
            imagePreview.src = URL.createObjectURL(currentFile);
            imagePreviewContainer.classList.remove('hidden');
        } else {
            imagePreviewContainer.classList.add('hidden');
        }
    }

    async function handleAnalyzeReceipt() {
        if (!currentFile) {
            alert('Najpierw wybierz plik z paragonem.');
            return;
        }
        analysisSpinner.classList.remove('hidden');
        analyzeReceiptBtn.disabled = true;
        imagePreviewContainer.classList.add('hidden');
        try {
            const { analysis } = await apiCallWithFile('/api/analyze-receipt', currentFile);
            fillFormWithAnalysis(analysis);
        } catch (error) {
            alert('Błąd analizy paragonu: ' + error.message);
        } finally {
            analysisSpinner.classList.add('hidden');
            analyzeReceiptBtn.disabled = false;
            receiptFileInput.value = '';
            currentFile = null;
        }
    }

    async function startCamera() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert("Twoja przeglądarka nie wspiera dostępu do aparatu.");
            return;
        }
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            cameraView.classList.remove('hidden');
            cameraStreamEl.srcObject = cameraStream;
        } catch (err) {
            alert("Nie udało się uzyskać dostępu do aparatu. Sprawdź uprawnienia w przeglądarce.");
        }
    }

    function stopCamera() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
        }
        cameraView.classList.add('hidden');
        cameraStream = null;
    }

    function capturePhoto() {
        const canvas = document.createElement('canvas');
        canvas.width = cameraStreamEl.videoWidth;
        canvas.height = cameraStreamEl.videoHeight;
        canvas.getContext('2d').drawImage(cameraStreamEl, 0, 0);
        canvas.toBlob(blob => {
            currentFile = new File([blob], "paragon.jpg", { type: "image/jpeg" });
            stopCamera();
            handleAnalyzeReceipt();
        }, 'image/jpeg');
    }

    function fillFormWithAnalysis(analysis) {
        shopInput.value = analysis.shop || '';
        dateInput.value = analysis.date || new Date().toISOString().split('T')[0];
        itemsContainer.innerHTML = '';
        
        const processedItems = (analysis.items || []).map(item => {
            const rawPrice = item.price ? item.price.toString().replace(',', '.') : '0';
            const parsedPrice = parseFloat(rawPrice);
            return {
                ...item,
                price: isNaN(parsedPrice) ? 0 : parseFloat(parsedPrice.toFixed(2))
            };
        });

        processedItems.forEach(item => {
            if (item.category && !allCategories.includes(item.category)) {
                allCategories.push(item.category);
                allCategories.sort();
            }
            addItemRow(item);
        });

        if (processedItems.length === 0) {
            addItemRow();
        }
        updateAllCategorySelects();
        alert('Formularz został wypełniony danymi z paragonu. Sprawdź dane przed zapisem.');
    }

    // --- Logika Statystyk ---
    async function renderStatistics() {
        try {
            const initialStats = await apiCall('/api/statistics');
            populateMonthSelector(initialStats.availableMonths);
            await updateCategoryPieChart();
            await renderComparisonBarChart();
        } catch (error) {
            console.error("Błąd ładowania statystyk:", error);
        }
    }

    function populateMonthSelector(availableMonths) {
        statsMonthSelect.innerHTML = '';
        if (!availableMonths || availableMonths.length === 0) {
            statsMonthSelect.innerHTML = '<option>Brak danych</option>';
            return;
        }
        availableMonths.forEach(monthStr => {
            const option = document.createElement('option');
            option.value = monthStr;
            const [y, m] = monthStr.split('-');
            option.textContent = new Date(y, m - 1).toLocaleString('pl-PL', { month: 'long', year: 'numeric' });
            statsMonthSelect.appendChild(option);
        });
    }

    async function updateCategoryPieChart() {
        const selectedMonth = statsMonthSelect.value;
        if (!selectedMonth || selectedMonth === 'Brak danych') {
            noDataPieChart.classList.remove('hidden');
            categoryChartContainer.classList.add('hidden');
            return;
        };

        const [year, month] = selectedMonth.split('-');
        const stats = await apiCall(`/api/statistics?year=${year}&month=${month}`);

        const ctx = document.getElementById('category-chart').getContext('2d');
        const labels = Object.keys(stats.spendingByCategory);
        const data = Object.values(stats.spendingByCategory);
        const backgroundColors = labels.map(label => getCategoryColor(label));

        if (categoryChart) categoryChart.destroy();

        if (labels.length === 0) {
            noDataPieChart.classList.remove('hidden');
            categoryChartContainer.classList.add('hidden');
        } else {
            noDataPieChart.classList.add('hidden');
            categoryChartContainer.classList.remove('hidden');
            categoryChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                    datasets: [{ data, backgroundColor: backgroundColors }]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });
        }
    }

    async function renderComparisonBarChart() {
        const stats = await apiCall('/api/statistics/comparison');
        const ctx = document.getElementById('comparison-chart').getContext('2d');

        if (comparisonChart) comparisonChart.destroy();

        if (!stats.monthlyTotals || stats.monthlyTotals.length === 0) {
            noDataBarChart.classList.remove('hidden');
            comparisonChartContainer.classList.add('hidden');
        } else {
            noDataBarChart.classList.add('hidden');
            comparisonChartContainer.classList.remove('hidden');
            const labels = stats.monthlyTotals.map(item => {
                const [y, m] = item.month.split('-');
                return new Date(y, m - 1).toLocaleString('pl-PL', { month: 'short', year: 'numeric' });
            });
            const data = stats.monthlyTotals.map(item => item.total);

            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Suma wydatków',
                        data,
                        backgroundColor: '#4F46E5'
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }
    }

    // --- Inicjalizacja Aplikacji ---
    async function checkAuthStatus() {
        const token = localStorage.getItem('authToken');
        if (!token) {
            loadingSection.classList.add('hidden');
            authSection.classList.remove('hidden');
            return;
        }
        try {
            await apiCall('/auth/status');
            await initializeApp();
        } catch (error) {
            logout(); // Token jest nieprawidłowy lub wygasł
        } finally {
            loadingSection.classList.add('hidden');
        }
    }

    async function initializeApp() {
        authSection.classList.add('hidden');
        appSection.classList.remove('hidden');
        setupAppEventListeners();
        await fetchInitialData();
        exitEditMode();
    }

    document.addEventListener('DOMContentLoaded', () => {
        setupAuthEventListeners();
        checkAuthStatus();

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('Service Worker zarejestrowany:', reg))
                .catch(err => console.log('Błąd rejestracji Service Workera:', err));
        }
    });
</script>
</body>
</html>
