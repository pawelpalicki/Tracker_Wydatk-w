<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker Wydatków</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta name="theme-color" content="#4F46E5"/>
    <link rel="apple-touch-icon" href="icon.svg">
    <style>
        .active { border-bottom-width: 2px; border-color: #4F46E5; color: #4F46E5; }
        .hidden { display: none; }
        .item-row:not(:last-child) { border-bottom: 1px solid #e5e7eb; }
        .category-tag {
            display: inline-block;
            padding: 0.1rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 0.5rem;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Sekcja Uwierzytelniania -->
    <div id="auth-section">
        <div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
            <div class="max-w-md w-full space-y-8">
                <div>
                    <h2 id="auth-title" class="mt-6 text-center text-3xl font-extrabold text-gray-900">Zaloguj się</h2>
                </div>
                <form id="login-form" class="mt-8 space-y-6">
                    <div class="rounded-md shadow-sm -space-y-px">
                        <div><input id="login-email" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Adres email"></div>
                        <div><input id="login-password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Hasło"></div>
                    </div>
                    <div><button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Zaloguj się</button></div>
                </form>
                <form id="register-form" class="mt-8 space-y-6 hidden">
                     <div class="rounded-md shadow-sm -space-y-px">
                        <div><input id="register-email" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Adres email"></div>
                        <div><input id="register-password" name="password" type="password" autocomplete="new-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Hasło"></div>
                    </div>
                     <div><button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Zarejestruj się</button></div>
                </form>
                <div class="text-sm text-center">
                    <a href="#" id="toggle-auth-mode" class="font-medium text-indigo-600 hover:text-indigo-500">Nie masz konta? Zarejestruj się</a>
                </div>
                 <div id="auth-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative"></div>
            </div>
        </div>
    </div>

    <!-- Główna Aplikacja -->
    <div id="app-section" class="hidden">
        <header class="bg-white shadow-md sticky top-0 z-10">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <h1 class="text-2xl font-bold text-gray-800">Tracker Zakupów</h1>
                    <div class="text-right">
                        <div id="monthly-balance-label" class="text-sm text-gray-500">Wydatki w tym miesiącu</div>
                        <div id="monthlyBalance" class="text-2xl font-bold text-red-600">-0.00 zł</div>
                    </div>
                    <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">Wyloguj</button>
                </div>
                <nav class="border-b border-gray-200">
                    <div class="flex -mb-px">
                        <button data-tab="add" class="nav-btn py-4 px-6">Dodaj Zakup</button>
                        <button data-tab="list" class="nav-btn py-4 px-6">Lista Zakupów</button>
                        <button data-tab="categories" class="nav-btn py-4 px-6">Kategorie</button>
                        <button data-tab="stats" class="nav-btn py-4 px-6">Statystyki</button>
                    </div>
                </nav>
            </div>
        </header>

        <main class="max-w-4xl mx-auto py-6 sm:px-6 lg:px-8">
            <div id="add-tab" class="tab-content">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Dodaj paragon skanując go</h3>
                    <div class="flex items-center space-x-4">
                        <input type="file" id="receipt-file-input" accept="image/*" class="hidden">
                        <button id="file-upload-btn" class="py-2 px-5 bg-gray-600 text-white rounded-md hover:bg-gray-700 whitespace-nowrap">Wybierz plik</button>
                        <button id="camera-btn" class="py-2 px-5 bg-blue-600 text-white rounded-md hover:bg-blue-700 whitespace-nowrap">Użyj aparatu</button>
                    </div>
                    <div id="camera-container" class="hidden mt-4">
                        <video id="camera-stream" class="w-full rounded-md" autoplay></video>
                        <canvas id="camera-canvas" class="hidden"></canvas>
                        <div class="flex justify-center mt-2 space-x-4">
                            <button id="capture-btn" class="py-2 px-5 bg-green-600 text-white rounded-md hover:bg-green-700">Zrób zdjęcie</button>
                            <button id="cancel-camera-btn" class="py-2 px-5 bg-red-600 text-white rounded-md hover:bg-red-700">Anuluj</button>
                        </div>
                    </div>
                    <div id="image-preview-container" class="hidden mt-4 text-center">
                        <img id="image-preview" class="max-w-xs mx-auto rounded-lg" />
                        <button id="analyze-receipt-btn" class="mt-2 py-2 px-5 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 whitespace-nowrap">Analizuj paragon</button>
                    </div>
                    <div id="analysis-spinner" class="hidden text-center mt-4">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div>
                        <p class="text-gray-600">Analizuję dane z paragonu, proszę czekać...</p>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 id="form-title" class="text-lg font-semibold mb-4">Dodaj nowy zakup ręcznie</h3>
                    <form id="purchase-form">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="shop" class="block text-sm font-medium text-gray-700">Sklep</label>
                                <input type="text" id="shop" required class="mt-1 block w-full rounded-md p-2 border-gray-300 shadow-sm"></div>
                            <div>
                                <label for="date" class="block text-sm font-medium text-gray-700">Data</label>
                                <input type="date" id="date" required class="mt-1 block w-full rounded-md p-2 border-gray-300 shadow-sm"></div>
                        </div>
                        <h4 class="text-md font-semibold mb-2">Pozycje na paragonie</h4>
                        <div id="items-container" class="space-y-2"></div>
                        <div id="total-amount-container" class="hidden mt-4 pt-4 border-t-2 border-dashed">
                            <div class="flex justify-end items-center">
                                <span class="text-lg font-bold text-gray-700 mr-2">Suma:</span>
                                <span id="total-amount-value" class="text-xl font-bold text-indigo-600">0.00 zł</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-4">
                            <button type="button" id="add-item-btn" class="py-2 px-4 bg-blue-500 text-white rounded-md hover:bg-blue-600">Dodaj pozycję</button>
                            <div>
                                <button type="button" id="cancel-edit-btn" class="py-2 px-4 bg-gray-500 text-white rounded-md hover:bg-gray-600 mr-2 hidden">Anuluj</button>
                                <button type="submit" id="purchase-form-submit-btn" class="py-2 px-4 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Zapisz cały zakup</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div id="list-tab" class="tab-content"><div id="purchases-list" class="space-y-4"></div></div>
            <div id="categories-tab" class="tab-content hidden bg-white rounded-lg shadow p-6">
                 <h3 class="text-lg font-semibold mb-4">Zarządzaj Kategoriami</h3>
                 <div id="categories-list" class="space-y-2"></div>
            </div>
            <div id="stats-tab" class="tab-content hidden space-y-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Wydatki w wybranym miesiącu</h3>
                    <div class="flex items-center space-x-4 mb-4">
                        <select id="stats-month-select" class="block w-full rounded-md p-2 border-gray-300 shadow-sm"></select>
                    </div>
                    <div id="category-chart-container" class="max-w-md mx-auto hidden">
                         <canvas id="category-chart"></canvas>
                    </div>
                     <p id="no-data-pie-chart" class="text-center text-gray-500 hidden">Brak danych dla wybranego miesiąca.</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Porównanie wydatków miesięcznych</h3>
                    <div id="comparison-chart-container" class="hidden">
                        <canvas id="comparison-chart"></canvas>
                    </div>
                    <p id="no-data-bar-chart" class="text-center text-gray-500 hidden">Brak danych do porównania.</p>
                </div>
            </div>
        </main>
    </div>

    <datalist id="category-suggestions"></datalist>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Stan Aplikacji ---
    let allPurchases = [];
    let allCategories = [];
    let editMode = { active: false, purchaseId: null };
    let currentFile = null;
    let cameraStream = null;
    let categoryChart = null;
    let comparisonChart = null;

    // --- Elementy DOM ---
    const authSection = document.getElementById('auth-section');
    const appSection = document.getElementById('app-section');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const toggleAuthLink = document.getElementById('toggle-auth-mode');
    const authTitle = document.getElementById('auth-title');
    const authErrorDiv = document.getElementById('auth-error');
    const logoutBtn = document.getElementById('logout-btn');
    const purchaseForm = document.getElementById('purchase-form');
    const formTitle = document.getElementById('form-title');
    const purchaseFormSubmitBtn = document.getElementById('purchase-form-submit-btn');
    const addItemBtn = document.getElementById('add-item-btn');
    const purchasesList = document.getElementById('purchases-list');
    const monthlyBalanceEl = document.getElementById('monthlyBalance');
    const monthlyBalanceLabel = document.getElementById('monthly-balance-label');
    const navBtns = document.querySelectorAll('.nav-btn');
    const itemsContainer = document.getElementById('items-container');
    const shopInput = document.getElementById('shop');
    const dateInput = document.getElementById('date');
    const categoriesList = document.getElementById('categories-list');
    const receiptFileInput = document.getElementById('receipt-file-input');
    const fileUploadBtn = document.getElementById('file-upload-btn');
    const cameraBtn = document.getElementById('camera-btn');
    const analyzeReceiptBtn = document.getElementById('analyze-receipt-btn');
    const analysisSpinner = document.getElementById('analysis-spinner');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const cameraContainer = document.getElementById('camera-container');
    const cameraStreamEl = document.getElementById('camera-stream');
    const cameraCanvas = document.getElementById('camera-canvas');
    const captureBtn = document.getElementById('capture-btn');
    const cancelCameraBtn = document.getElementById('cancel-camera-btn');
    const totalAmountContainer = document.getElementById('total-amount-container');
    const totalAmountValue = document.getElementById('total-amount-value');
    const statsMonthSelect = document.getElementById('stats-month-select');
    const noDataPieChart = document.getElementById('no-data-pie-chart');
    const noDataBarChart = document.getElementById('no-data-bar-chart');
    const categoryChartContainer = document.getElementById('category-chart-container');
    const comparisonChartContainer = document.getElementById('comparison-chart-container');

    // --- Funkcje Pomocnicze ---
    const categoryColors = {};
    const colorPalette = ['#3b82f6', '#10b981', '#ef4444', '#f97316', '#8b5cf6', '#ec4899', '#f59e0b', '#14b8a6', '#64748b', '#06b6d4'];
    let colorIndex = 0;

    function getCategoryColor(category) {
        if (!category) return '#6b7280';
        if (!categoryColors[category]) {
            categoryColors[category] = colorPalette[colorIndex % colorPalette.length];
            colorIndex++;
        }
        return categoryColors[category];
    }

    // --- Funkcje API ---
    async function apiCall(endpoint, method = 'GET', body = null) {
        const token = localStorage.getItem('authToken');
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['X-Auth-Token'] = token;
        const config = { method, headers };
        if (body) config.body = JSON.stringify(body);
        const response = await fetch(endpoint, config);
        if (response.status === 401) throw new Error('Nieprawidłowy token.');
        if (response.status === 204) return null;
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Błąd serwera');
        return data;
    }

    async function apiCallWithFile(endpoint, file) {
        const token = localStorage.getItem('authToken');
        const formData = new FormData();
        formData.append('image', file);
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'X-Auth-Token': token },
            body: formData
        });
        if (response.status === 401) throw new Error('Nieprawidłowy token.');
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Błąd serwera');
        return data;
    }

    // --- Logika Uwierzytelniania ---
    function setupAuthEventListeners() {
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authErrorDiv.classList.add('hidden');
            try {
                const data = await apiCall('/auth/login', 'POST', { email: loginForm.email.value, password: loginForm.password.value });
                localStorage.setItem('authToken', data.token);
                main();
            } catch (error) {
                authErrorDiv.textContent = error.message;
                authErrorDiv.classList.remove('hidden');
            }
        });
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authErrorDiv.classList.add('hidden');
            try {
                await apiCall('/auth/register', 'POST', { email: registerForm.email.value, password: registerForm.password.value });
                alert('Rejestracja pomyślna! Możesz się teraz zalogować.');
                toggleAuthForms();
            } catch (error) {
                authErrorDiv.textContent = error.message;
                authErrorDiv.classList.remove('hidden');
            }
        });
        toggleAuthLink.addEventListener('click', (e) => {
            e.preventDefault();
            toggleAuthForms();
        });
    }

    function showLoginScreen() {
        localStorage.removeItem('authToken');
        authSection.classList.remove('hidden');
        appSection.classList.add('hidden');
        setupAuthEventListeners();
    }

    function toggleAuthForms() {
        const isLoginHidden = loginForm.classList.toggle('hidden');
        registerForm.classList.toggle('hidden');
        authTitle.textContent = isLoginHidden ? 'Stwórz nowe konto' : 'Zaloguj się';
        toggleAuthLink.textContent = isLoginHidden ? 'Masz już konto? Zaloguj się' : 'Nie masz konta? Zarejestruj się';
    }

    // --- Logika Aparatu ---
    async function startCamera() {
        try {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                cameraStreamEl.srcObject = cameraStream;
                cameraContainer.classList.remove('hidden');
                imagePreviewContainer.classList.add('hidden');
            } else {
                alert('Twoja przeglądarka nie wspiera dostępu do aparatu.');
            }
        } catch (error) {
            console.error("Błąd uruchamiania kamery:", error);
            alert('Nie udało się uruchomić kamery. Sprawdź uprawnienia w przeglądarce.');
        }
    }

    function stopCamera() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
        }
        cameraContainer.classList.add('hidden');
    }

    function takePicture() {
        const video = cameraStreamEl;
        const canvas = cameraCanvas;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        canvas.toBlob(blob => {
            currentFile = new File([blob], "paragon.jpg", { type: "image/jpeg" });
            imagePreview.src = URL.createObjectURL(currentFile);
            imagePreviewContainer.classList.remove('hidden');
            stopCamera();
        }, 'image/jpeg');
    }

    // --- Główna Logika Aplikacji ---
    function setupAppEventListeners() {
        logoutBtn.addEventListener('click', showLoginScreen);
        navBtns.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
        purchaseForm.addEventListener('submit', handlePurchaseFormSubmit);
        addItemBtn.addEventListener('click', () => addItemRow());
        document.getElementById('cancel-edit-btn').addEventListener('click', () => {
            exitEditMode();
            switchTab('list');
        });

        fileUploadBtn.addEventListener('click', () => receiptFileInput.click());
        receiptFileInput.addEventListener('change', (event) => {
            if (event.target.files && event.target.files[0]) {
                currentFile = event.target.files[0];
                imagePreview.src = URL.createObjectURL(currentFile);
                imagePreviewContainer.classList.remove('hidden');
                stopCamera();
            }
        });
        
        cameraBtn.addEventListener('click', startCamera);
        captureBtn.addEventListener('click', takePicture);
        cancelCameraBtn.addEventListener('click', stopCamera);

        analyzeReceiptBtn.addEventListener('click', handleAnalyzeReceipt);
        statsMonthSelect.addEventListener('change', updateCategoryPieChart);

        purchasesList.addEventListener('click', async (e) => {
            const purchaseId = e.target.closest('[data-purchase-id]')?.dataset.purchaseId;
            if (!purchaseId) return;
            if (e.target.closest('.edit-purchase-btn')) enterEditMode(purchaseId);
            else if (e.target.closest('.delete-purchase-btn')) {
                if (confirm('Czy na pewno chcesz usunąć ten zakup? Operacja jest nieodwracalna.')) {
                    try {
                        await apiCall(`/api/purchases/${purchaseId}`, 'DELETE');
                        await fetchInitialData(false);
                    } catch (error) {
                        alert('Nie udało się usunąć zakupu: ' + error.message);
                    }
                }
            }
        });

        categoriesList.addEventListener('click', async (e) => {
            const categoryDiv = e.target.closest('[data-category-name]');
            if (!categoryDiv) return;
            const categoryName = categoryDiv.dataset.categoryName;
            if (e.target.closest('.rename-cat-btn')) {
                const newName = prompt(`Wprowadź nową nazwę dla kategorii "${categoryName}":`, categoryName);
                if (newName && newName.trim() !== '' && newName !== categoryName) {
                    try {
                        await apiCall(`/api/categories/${categoryName}`, 'PUT', { newName: newName.trim().toLowerCase() });
                        await fetchInitialData(false);
                    } catch (error) {
                        alert('Nie udało się zmienić nazwy: ' + error.message);
                    }
                }
            } else if (e.target.closest('.delete-cat-btn')) {
                if (confirm(`Czy na pewno chcesz usunąć kategorię "${categoryName}"? Wszystkie produkty z tą kategorią zostaną oznaczone jako "inne".`)) {
                    try {
                        await apiCall(`/api/categories/${categoryName}`, 'DELETE');
                        await fetchInitialData(false);
                    } catch (error) {
                        alert('Nie udało się usunąć kategorii: ' + error.message);
                    }
                }
            }
        });
    }

    function switchTab(tabName) {
        navBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabName));
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.toggle('hidden', content.id !== `${tabName}-tab`);
        });
        if (tabName !== 'add') exitEditMode();
        if (tabName === 'categories') renderCategoriesList();
        if (tabName === 'stats') renderStatistics();
    }

    async function fetchInitialData(shouldSwitchToList = true) {
        const [purchases, categories] = await Promise.all([apiCall('/api/purchases'), apiCall('/api/categories')]);
        allPurchases = purchases;
        allCategories = categories.sort();
        renderAll();
        if (shouldSwitchToList) switchTab('list');
    }

    function renderAll() {
        renderPurchasesList();
        updateMonthlyBalance();
        if (!document.getElementById('categories-tab').classList.contains('hidden')) renderCategoriesList();
    }

    function updateAllCategorySelects(newlySelected = null) {
        const categoryOptions = allCategories.map(cat => `<option value="${cat}">${cat.charAt(0).toUpperCase() + cat.slice(1)}</option>`).join('');
        const fullHtml = `<option value="" disabled>Wybierz kategorię</option>${categoryOptions}<option value="__add_new__" class="font-bold text-indigo-600">+ Dodaj nową</option>`;
        document.querySelectorAll('.item-category-select').forEach(select => {
            const currentValue = select.value;
            select.innerHTML = fullHtml;
            select.value = newlySelected || currentValue;
        });
    }

    function addItemRow(item = { name: '', price: '', category: '' }) {
        const itemRow = document.createElement('div');
        itemRow.className = 'item-row grid grid-cols-1 md:grid-cols-4 gap-2 items-center py-2';
        const categoryOptions = allCategories.map(cat => `<option value="${cat}">${cat.charAt(0).toUpperCase() + cat.slice(1)}</option>`).join('');
        itemRow.innerHTML = `
            <div class="md:col-span-2"><input type="text" placeholder="Opis produktu" required class="item-name w-full rounded-md p-2 border-gray-300 shadow-sm" value="${item.name}"></div>
            <div><input type="number" step="0.01" placeholder="Kwota" required class="item-price w-full rounded-md p-2 border-gray-300 shadow-sm" value="${item.price}"></div>
            <div class="flex items-center gap-2">
                <div class="category-wrapper w-full">
                    <select class="item-category-select w-full rounded-md p-2 border-gray-300 shadow-sm">
                        <option value="" disabled ${!item.category ? 'selected' : ''}>Wybierz kategorię</option>
                        ${categoryOptions}
                        <option value="__add_new__" class="font-bold text-indigo-600">+ Dodaj nową</option>
                    </select>
                    <input type="text" placeholder="Nowa kategoria" class="item-category-new w-full rounded-md p-2 border-gray-300 shadow-sm hidden">
                </div>
                <button type="button" class="remove-item-btn text-red-500 hover:text-red-700">✖</button>
            </div>`;
        itemsContainer.appendChild(itemRow);
        const categorySelect = itemRow.querySelector('.item-category-select');
        const newCategoryInput = itemRow.querySelector('.item-category-new');
        if (item.category && allCategories.includes(item.category)) categorySelect.value = item.category;
        categorySelect.addEventListener('change', () => {
            if (categorySelect.value === '__add_new__') {
                categorySelect.classList.add('hidden');
                newCategoryInput.classList.remove('hidden');
                newCategoryInput.focus();
            }
        });
        newCategoryInput.addEventListener('blur', () => {
            const newCategory = newCategoryInput.value.trim().toLowerCase();
            if (newCategory && !allCategories.includes(newCategory)) {
                allCategories.push(newCategory);
                allCategories.sort();
                updateAllCategorySelects(newCategory);
            }
            newCategoryInput.classList.add('hidden');
            categorySelect.classList.remove('hidden');
            if (newCategory) categorySelect.value = newCategory;
        });
        itemRow.querySelector('.remove-item-btn').addEventListener('click', () => itemRow.remove());
    }

    async function handlePurchaseFormSubmit(e) {
        e.preventDefault();
        const purchaseData = {
            shop: shopInput.value,
            date: dateInput.value,
            items: Array.from(document.querySelectorAll('.item-row')).map(row => ({
                name: row.querySelector('.item-name').value,
                price: parseFloat(row.querySelector('.item-price').value),
                category: row.querySelector('.item-category-select').value || 'inne'
            }))
        };
        try {
            if (editMode.active) {
                await apiCall(`/api/purchases/${editMode.purchaseId}`, 'PUT', purchaseData);
            } else {
                await apiCall('/api/purchases', 'POST', purchaseData);
            }
            exitEditMode();
            await fetchInitialData();
        } catch(error) {
            alert('Błąd zapisu: ' + error.message);
            if (error.message === 'Nieprawidłowy token.') showLoginScreen();
        }
    }

    function enterEditMode(purchaseId) {
        const purchase = allPurchases.find(p => p.id === purchaseId);
        if (!purchase) return;
        editMode.active = true;
        editMode.purchaseId = purchaseId;
        shopInput.value = purchase.shop;
        dateInput.value = purchase.date;
        itemsContainer.innerHTML = '';
        purchase.items.forEach(item => addItemRow(item));
        formTitle.textContent = 'Edytuj istniejący zakup';
        purchaseFormSubmitBtn.textContent = 'Zaktualizuj zakup';
        purchaseFormSubmitBtn.classList.replace('bg-indigo-600', 'bg-green-600');
        purchaseFormSubmitBtn.classList.replace('hover:bg-indigo-700', 'hover:bg-green-700');
        document.getElementById('cancel-edit-btn').classList.remove('hidden');
        switchTab('add');
    }

    function exitEditMode() {
        editMode.active = false;
        editMode.purchaseId = null;
        purchaseForm.reset();
        itemsContainer.innerHTML = '';
        dateInput.value = new Date().toISOString().split('T')[0];
        addItemRow();
        formTitle.textContent = 'Dodaj nowy zakup ręcznie';
        purchaseFormSubmitBtn.textContent = 'Zapisz cały zakup';
        purchaseFormSubmitBtn.classList.replace('bg-green-600', 'bg-indigo-600');
        purchaseFormSubmitBtn.classList.replace('hover:bg-green-700', 'hover:bg-indigo-700');
        document.getElementById('cancel-edit-btn').classList.add('hidden');
        totalAmountContainer.classList.add('hidden');
    }

    function renderPurchasesList() {
        purchasesList.innerHTML = allPurchases.length === 0 ? '<p class="text-center text-gray-500">Brak zapisanych zakupów.</p>' :
            allPurchases.map(p => `
            <div class="bg-white rounded-lg shadow" data-purchase-id="${p.id}">
                <div class="p-4 flex justify-between items-center">
                    <div class="cursor-pointer flex-grow" onclick="this.parentElement.nextElementSibling.classList.toggle('hidden')">
                        <p class="font-bold text-lg">${ p.shop || 'Brak nazwy sklepu' }</p>
                        <p class="text-sm text-gray-600">${ p.date ? new Date(p.date).toLocaleDateString('pl-PL') : 'Brak daty' }</p>
                    </div>
                    <div class="text-right mr-4">
                        <p class="font-bold text-xl">${(p.totalAmount || 0).toFixed(2)} zł</p>
                        <p class="text-xs text-gray-500">${(p.items || []).length} poz.</p>
                    </div>
                    <div class="flex items-center">
                        <button class="edit-purchase-btn p-2 text-blue-500 hover:text-blue-700" title="Edytuj"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                        <button class="delete-purchase-btn p-2 text-red-500 hover:text-red-700" title="Usuń"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                    </div>
                </div>
                <div class="purchase-items hidden border-t p-4 space-y-2">
                    ${(p.items || []).map(item => `
                        <div class="flex justify-between items-center">
                            <div>
                                <span>${item.name || 'Brak nazwy produktu'}</span>
                                <span class="category-tag" style="background-color: ${getCategoryColor(item.category)}">${item.category || 'brak'}</span>
                            </div>
                            <span class="font-medium">${(item.price || 0).toFixed(2)} zł</span>
                        </div>`).join('')}
                </div>
            </div>`).join('');
    }

    function renderCategoriesList() {
        categoriesList.innerHTML = allCategories.map(cat => `
            <div class="flex justify-between items-center p-2 border-b" data-category-name="${cat}">
                <span class="category-text">${cat.charAt(0).toUpperCase() + cat.slice(1)}</span>
                <div class="category-actions">
                    <button class="rename-cat-btn p-1 text-blue-500 hover:text-blue-700" title="Zmień nazwę"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                    <button class="delete-cat-btn p-1 text-red-500 hover:text-red-700" title="Usuń"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                </div>
            </div>`).join('');
    }

    function updateMonthlyBalance() {
        const monthName = new Date().toLocaleString('pl-PL', { month: 'long' });
        monthlyBalanceLabel.textContent = `Wydatki w ${monthName.charAt(0).toUpperCase() + monthName.slice(1)}`;
        const currentMonthStr = new Date().toISOString().substring(0, 7);
        const total = allPurchases
            .filter(p => p.date && p.date.startsWith(currentMonthStr))
            .reduce((sum, p) => sum + (p.totalAmount || 0), 0);
        monthlyBalanceEl.textContent = `-${total.toFixed(2)} zł`;
    }

    async function handleAnalyzeReceipt() {
        if (!currentFile) {
            alert('Najpierw wybierz plik lub zrób zdjęcie paragonu.');
            return;
        }
        analysisSpinner.classList.remove('hidden');
        analyzeReceiptBtn.disabled = true;
        try {
            const result = await apiCallWithFile('/api/analyze-receipt', currentFile);
            fillFormWithAnalysis(result.analysis);
        } catch (error) {
            alert('Błąd analizy paragonu: ' + error.message);
            if (error.message === 'Nieprawidłowy token.') showLoginScreen();
        } finally {
            analysisSpinner.classList.add('hidden');
            analyzeReceiptBtn.disabled = false;
        }
    }

    function fillFormWithAnalysis(data) {
        shopInput.value = data.shop || '';
        dateInput.value = data.date || new Date().toISOString().split('T')[0];
        itemsContainer.innerHTML = '';
        let total = 0;
        if (data.items && data.items.length > 0) {
            data.items.forEach(item => {
                addItemRow(item);
                total += item.price || 0;
            });
        } else {
            addItemRow();
        }
        totalAmountValue.textContent = `${total.toFixed(2)} zł`;
        totalAmountContainer.classList.remove('hidden');
        alert('Formularz został wypełniony danymi z paragonu. Sprawdź dane przed zapisem.');
    }
    
    async function renderStatistics() {
        try {
            const initialStats = await apiCall('/api/statistics'); // Fetch initial data for current month and available months
            populateMonthSelector(initialStats.availableMonths);
            updateCategoryPieChart(initialStats);
            renderComparisonBarChart();
        } catch (error) {
            console.error("Błąd ładowania statystyk:", error);
        }
    }

    function populateMonthSelector(availableMonths) {
        statsMonthSelect.innerHTML = '';
        if (!availableMonths || availableMonths.length === 0) {
            statsMonthSelect.innerHTML = '<option>Brak danych</option>';
            return;
        }
        availableMonths.forEach(monthStr => {
            const option = document.createElement('option');
            option.value = monthStr;
            const [y, m] = monthStr.split('-');
            option.textContent = new Date(y, m - 1).toLocaleString('pl-PL', { month: 'long', year: 'numeric' });
            statsMonthSelect.appendChild(option);
        });
    }

    async function updateCategoryPieChart() {
        const selectedMonth = statsMonthSelect.value;
        if (!selectedMonth) {
            noDataPieChart.classList.remove('hidden');
            categoryChartContainer.classList.add('hidden');
            return;
        };
        
        const [year, month] = selectedMonth.split('-');
        const stats = await apiCall(`/api/statistics?year=${year}&month=${month}`);
        
        const ctx = document.getElementById('category-chart').getContext('2d');
        const labels = Object.keys(stats.spendingByCategory);
        const data = Object.values(stats.spendingByCategory);
        const backgroundColors = labels.map(label => getCategoryColor(label));

        if (categoryChart) categoryChart.destroy();

        if (labels.length === 0) {
            noDataPieChart.classList.remove('hidden');
            categoryChartContainer.classList.add('hidden');
        } else {
            noDataPieChart.classList.add('hidden');
            categoryChartContainer.classList.remove('hidden');
            categoryChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                    datasets: [{ data, backgroundColor: backgroundColors }]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });
        }
    }

    async function renderComparisonBarChart() {
        const stats = await apiCall('/api/statistics/comparison');
        const ctx = document.getElementById('comparison-chart').getContext('2d');
        
        if (comparisonChart) comparisonChart.destroy();

        if (!stats.monthlyTotals || stats.monthlyTotals.length === 0) {
            noDataBarChart.classList.remove('hidden');
            comparisonChartContainer.classList.add('hidden');
        } else {
            noDataBarChart.classList.add('hidden');
            comparisonChartContainer.classList.remove('hidden');
            const labels = stats.monthlyTotals.map(item => {
                const [y, m] = item.month.split('-');
                return new Date(y, m - 1).toLocaleString('pl-PL', { month: 'short', year: 'numeric' });
            });
            const data = stats.monthlyTotals.map(item => item.total);

            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Suma wydatków',
                        data,
                        backgroundColor: '#4F46E5'
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }
    }

    // --- Inicjalizacja Aplikacji ---
    async function main() {
        if (!localStorage.getItem('authToken')) {
            showLoginScreen();
            return;
        }
        try {
            setupAppEventListeners();
            await fetchInitialData();
            authSection.classList.add('hidden');
            appSection.classList.remove('hidden');
            dateInput.value = new Date().toISOString().split('T')[0];
            addItemRow();
        } catch (error) {
            console.error("Błąd inicjalizacji:", error.message);
            if (error.message === 'Nieprawidłowy token.') showLoginScreen();
        }
    }

    main();
});
</script>
</body>
</html>