<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker Wydatków</title>
    <meta name="description" content="Aplikacja do śledzenia wydatków z inteligentną analizą paragonów.">
    <meta name="theme-color" content="#4F46E5" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link rel="manifest" href="manifest.json" crossorigin="use-credentials">
    <link rel="icon" href="icon-new.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="icon-new.svg">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body class="bg-gray-50 dark:bg-gray-900">

    <div id="loading-section"
        class="min-h-screen flex flex-col items-center justify-center bg-gray-50 dark:bg-gray-900">
        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600"></div>
        <p class="mt-4 text-lg text-gray-600 dark:text-gray-300">Wczytuję aplikację...</p>
    </div>

    <div id="auth-section"
        class="hidden min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <h2 id="auth-title" class="mt-6 text-center text-3xl font-extrabold text-gray-900 dark:text-white">
                    Zaloguj się do swojego konta</h2>
            </div>
            <form id="login-form" class="mt-8 space-y-6" action="#" method="POST">
                <input type="hidden" name="remember" value="true">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div><input id="login-email" name="email" type="email" autocomplete="email" required
                            class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 text-gray-900 dark:text-white bg-white dark:bg-gray-800 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                            placeholder="Adres email"></div>
                    <div><input id="login-password" name="password" type="password" autocomplete="current-password"
                            required
                            class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 text-gray-900 dark:text-white bg-white dark:bg-gray-800 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                            placeholder="Hasło"></div>
                </div>
                <div>
                    <button type="submit"
                        class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50">
                        <span class="button-text">Zaloguj się</span>
                        <span class="button-spinner hidden absolute right-4 top-1/2 -translate-y-1/2">
                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                        </span>
                    </button>
                </div>
            </form>
            <form id="register-form" class="mt-8 space-y-6 hidden" action="#" method="POST">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div><input id="register-email" name="email" type="email" autocomplete="email" required
                            class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 text-gray-900 dark:text-white bg-white dark:bg-gray-800 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                            placeholder="Adres email"></div>
                    <div><input id="register-password" name="password" type="password" autocomplete="new-password"
                            required
                            class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 text-gray-900 dark:text-white bg-white dark:bg-gray-800 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                            placeholder="Hasło"></div>
                </div>
                <div><button type="submit"
                        class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Zarejestruj
                        się</button></div>
            </form>
            <div class="text-center">
                <a href="#" id="switch-auth-link" class="font-medium text-blue-600 hover:text-blue-500">Nie masz konta?
                    Zarejestruj się</a>
            </div>
            <div id="auth-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative"
                role="alert"></div>
        </div>
    </div>

    <div id="app-section" class="hidden">
        <header class="bg-white dark:bg-gray-800 shadow-sm">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-20">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Tracker Wydatków</h1>
                <div id="monthly-balance" class="text-right mr-4">
                    <p id="monthly-balance-label" class="text-sm text-gray-500 dark:text-gray-400">Wydatki w miesiącu
                    </p>
                    <p id="monthly-balance-value" class="text-xl font-bold text-blue-600 dark:text-blue-400">0.00 zł</p>
                </div>
                <button id="logout-btn"
                    class="p-2 text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-white"
                    title="Wyloguj się">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </button>
            </div>
        </header>

        <main class="max-w-4xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- Nawigacja w formie pigułek -->
            <nav
                class="p-1.5 mb-6 max-w-lg mx-auto bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center space-x-1">
                <button data-tab="stats" class="nav-btn flex-1 text-center py-3 px-2 rounded-full" title="Kokpit">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                </button>
                <button data-tab="list" class="nav-btn flex-1 text-center py-3 px-2 rounded-full" title="Lista">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                    </svg>
                </button>
                <button data-tab="add" class="nav-btn flex-1 text-center py-3 px-2 rounded-full" title="Dodaj">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                </button>
                <button data-tab="settings" class="nav-btn flex-1 text-center py-3 px-2 rounded-full"
                    title="Ustawienia">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </nav>

            <!-- Kokpit / Statystyki -->
            <div id="stats-tab" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div
                        class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 flex flex-col items-center justify-center text-center">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Szybkie Akcje</h3>
                        <div class="flex space-x-4 mt-2">
                            <button id="quick-add-manual-btn"
                                class="flex flex-col items-center px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mb-1" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                                <span>Dodaj ręcznie</span>
                            </button>
                            <button id="quick-add-scan-btn"
                                class="flex flex-col items-center px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mb-1" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm1.5 4a.5.5 0 00-.5.5v3a.5.5 0 00.5.5h3a.5.5 0 00.5-.5v-3a.5.5 0 00-.5-.5h-3zM8 8a.5.5 0 01.5-.5h5a.5.5 0 010 1h-5A.5.5 0 018 8zm.5 3.5a.5.5 0 00-.5.5v3a.5.5 0 00.5.5h3a.5.5 0 00.5-.5v-3a.5.5 0 00-.5-.5h-3z"
                                        clip-rule="evenodd" />
                                </svg>
                                <span>Skanuj paragon</span>
                            </button>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 id="stats-title" class="text-lg font-semibold text-gray-900 dark:text-white">Wydatki w
                                miesiącu</h3>
                            <select id="stats-month-select"
                                class="block w-auto rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 text-sm"></select>
                        </div>
                        <div id="category-chart-container" class="h-48">
                            <canvas id="category-chart"></canvas>
                        </div>
                        <div id="no-data-pie-chart" class="hidden text-center py-12">
                            <p class="text-gray-500 dark:text-gray-400">Brak danych o wydatkach w wybranym miesiącu.</p>
                        </div>
                        <!-- Podsumowanie budżetu -->
                        <div id="budget-summary-container"
                            class="mt-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg hidden">
                            <h4 class="text-md font-semibold text-gray-900 dark:text-white mb-3">Podsumowanie budżetu
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                                <div class="bg-white dark:bg-gray-800 p-3 rounded-lg">
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Zaplanowany budżet</p>
                                    <p id="total-budget" class="text-lg font-bold text-blue-600 dark:text-blue-400">0.00
                                        zł</p>
                                </div>
                                <div class="bg-white dark:bg-gray-800 p-3 rounded-lg">
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Wydane</p>
                                    <p id="total-spent" class="text-lg font-bold text-red-600 dark:text-red-400">0.00 zł
                                    </p>
                                </div>
                                <div class="bg-white dark:bg-gray-800 p-3 rounded-lg">
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Pozostało</p>
                                    <p id="total-remaining"
                                        class="text-lg font-bold text-green-600 dark:text-green-400">0.00 zł</p>
                                </div>
                            </div>
                            <div id="unbudgeted-expenses"
                                class="mt-3 p-3 bg-yellow-50 dark:bg-yellow-900 rounded-lg hidden">
                                <p class="text-sm font-medium text-yellow-800 dark:text-yellow-200">⚠️ Wydatki bez
                                    budżetu</p>
                                <p id="unbudgeted-amount"
                                    class="text-lg font-bold text-yellow-700 dark:text-yellow-300">0.00 zł</p>
                                <p id="unbudgeted-categories" class="text-xs text-yellow-600 dark:text-yellow-400 mt-1">
                                </p>
                            </div>
                        </div>
                        <div id="budget-progress-container" class="mt-4 space-y-3">
                            <!-- Paski postępu budżetu zostaną wyrenderowane tutaj -->
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Porównanie wydatków w ostatnich
                        miesiącach</h3>
                    <div id="comparison-chart-container">
                        <canvas id="comparison-chart"></canvas>
                    </div>
                    <div id="no-data-bar-chart" class="hidden text-center py-12">
                        <p class="text-gray-500 dark:text-gray-400">Brak historii wydatków do porównania.</p>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Wydatki w podziale na sklepy
                    </h3>
                    <div id="shop-chart-container">
                        <canvas id="shop-chart"></canvas>
                    </div>
                    <div id="no-data-shop-chart" class="hidden text-center py-12">
                        <p class="text-gray-500 dark:text-gray-400">Brak danych o wydatkach w sklepach w wybranym
                            miesiącu.</p>
                    </div>
                </div>
            </div>

            <div id="add-tab" class="tab-content">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Dodaj paragon skanując go</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                        <div>
                            <input type="file" id="receipt-file-input" accept="image/*,application/pdf"
                                class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 dark:file:bg-blue-900 file:text-blue-700 dark:file:text-blue-300 hover:file:bg-blue-100 dark:hover:file:bg-blue-800">
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="analyze-receipt-btn"
                                class="w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 whitespace-nowrap">Analizuj
                                paragon</button>
                            <button id="start-camera-btn"
                                class="w-full py-2 px-4 bg-green-600 text-white rounded-md hover:bg-green-700 whitespace-nowrap">Użyj
                                aparatu</button>
                        </div>
                    </div>
                    <div id="image-preview-container" class="hidden mt-4">
                        <img id="image-preview" class="max-h-48 mx-auto rounded-lg" />
                    </div>
                    <div id="analysis-spinner" class="hidden text-center mt-4">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                        <p class="text-gray-600 dark:text-gray-300">Analizuję dane z paragonu, proszę czekać...</p>
                    </div>
                    <div id="camera-view" class="hidden mt-4">
                        <video id="camera-stream" class="w-full rounded-lg" autoplay></video>
                        <div class="flex items-center space-x-2 mt-2">
                            <button id="capture-photo-btn"
                                class="w-full py-2 px-4 bg-green-600 text-white rounded-md hover:bg-green-700">Zrób
                                zdjęcie</button>
                            <button id="cancel-camera-btn"
                                class="w-full py-2 px-4 bg-gray-500 text-white rounded-md hover:bg-gray-600">Anuluj</button>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                    <h3 id="purchase-form-title" class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Dodaj
                        nowy zakup ręcznie</h3>
                    <form id="purchase-form">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="md:col-span-2">
                                <label for="shop"
                                    class="block text-sm font-medium text-gray-700 dark:text-gray-300">Sklep</label>
                                <div class="relative">
                                    <input type="text" id="shop" required
                                        class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-3">
                                    <div id="shop-autocomplete-list"
                                        class="absolute z-10 w-full bg-white dark:bg-gray-600 rounded-md shadow-lg mt-1 hidden max-h-60 overflow-auto">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label for="date"
                                    class="block text-sm font-medium text-gray-700 dark:text-gray-300">Data</label>
                                <div class="relative mt-1">
                                    <input type="date" id="date" required
                                        class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-3">
                                </div>
                            </div>
                            <div id="total-amount-container" class="hidden md:col-span-3">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Suma</label>
                                <p id="total-amount-value" class="mt-1 text-xl font-bold text-gray-900 dark:text-white">
                                    0.00 zł</p>
                            </div>
                        </div>
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h4 class="text-md font-medium text-gray-800 dark:text-gray-200 mb-2">Pozycje na paragonie
                            </h4>
                            <div id="items-container" class="space-y-4"></div>
                            <div
                                class="border-t border-gray-200 dark:border-gray-700 mt-4 pt-4 flex justify-between items-center flex-wrap">
                                <div id="purchase-summary" class="text-lg font-bold text-gray-800 dark:text-gray-200">
                                    Suma: 0.00 zł</div>
                                <button type="button" id="add-item-btn"
                                    class="py-2 px-4 bg-blue-500 text-white rounded-md hover:bg-blue-600">+
                                    Dodaj</button>
                            </div>
                        </div>
                        <div class="flex justify-end mt-4">
                            <div class="flex items-center space-x-2">
                                <button type="button" id="cancel-edit-btn"
                                    class="py-2 px-4 bg-gray-500 text-white rounded-md hover:bg-gray-600 hidden">Anuluj</button>
                                <button type="submit"
                                    class="py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700">Zapisz cały
                                    zakup</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div id="list-tab" class="tab-content">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4 mb-6">
                    <div id="filter-toggle" class="cursor-pointer flex justify-between items-center">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Filtry</h4>
                        <svg id="filter-arrow" xmlns="http://www.w3.org/2000/svg"
                            class="h-6 w-6 text-gray-500 dark:text-gray-400 transition-transform" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div id="filters-container" class="hidden mt-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <input type="text" id="filter-keyword" placeholder="Szukaj produktu..."
                                class="block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2">
                            <input type="text" id="filter-date-range" placeholder="Wybierz zakres dat"
                                class="block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2">
                            <select id="filter-category"
                                class="block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2">
                                <option value="">Wszystkie kategorie</option>
                            </select>
                            <select id="filter-shop"
                                class="block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2">
                                <option value="">Wszystkie sklepy</option>
                            </select>
                            <input type="number" id="filter-min-amount" placeholder="Kwota od"
                                class="block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2">
                            <input type="number" id="filter-max-amount" placeholder="Kwota do"
                                class="block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2">
                        </div>
                        <div class="flex justify-end mt-4">
                            <button id="clear-filters-btn"
                                class="py-2 px-4 bg-gray-500 text-white rounded-md hover:bg-gray-600">Wyczyść
                                filtry</button>
                        </div>
                    </div>
                </div>
                <div id="purchases-list" class="space-y-4"></div>
            </div>

            <div id="settings-tab" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Zarządzanie Kategoriami -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Zarządzaj Kategoriami</h3>
                        <div id="categories-list" class="space-y-2 mb-4 max-h-96 overflow-y-auto"></div>
                        <form id="add-category-form" class="flex items-center space-x-2">
                            <input type="text" id="new-category-name" placeholder="Nazwa nowej kategorii"
                                class="flex-grow mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2">
                            <button type="submit"
                                class="py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700">Dodaj</button>
                        </form>
                    </div>

                    <!-- Zarządzanie Budżetem -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Zarządzaj Budżetem</h3>
                        <div class="flex items-center justify-between mb-3">
                            <label for="budget-month-select"
                                class="text-sm font-medium text-gray-700 dark:text-gray-300">Miesiąc:</label>
                            <select id="budget-month-select"
                                class="block w-auto rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 text-sm"></select>
                        </div>
                        <div id="budgets-list" class="space-y-2 mb-4 max-h-80 overflow-y-auto"></div>
                        <div class="space-y-2">
                            <button id="save-budget-btn"
                                class="w-full py-2 px-4 bg-green-600 text-white rounded-md hover:bg-green-700">Zapisz
                                budżet</button>
                            <button id="copy-budget-btn"
                                class="w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700">Kopiuj na
                                następne miesiące</button>
                        </div>
                    </div>
                </div>

                <!-- Wydatki Cykliczne -->
                <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Wydatki Cykliczne (Subskrypcje)
                    </h3>
                    <div id="recurring-expenses-list" class="space-y-3 mb-4"></div>
                    <form id="add-recurring-expense-form" class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg space-y-4">
                        <h4 class="font-semibold text-gray-800 dark:text-white">Dodaj nowy wydatek cykliczny</h4>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <input type="text" id="recurring-name" placeholder="Nazwa (np. Netflix)" required
                                class="md:col-span-2 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2">
                            <input type="number" id="recurring-amount" placeholder="Kwota" required step="0.01"
                                class="block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2">
                            <select id="recurring-category" required
                                class="block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2"></select>
                            <input type="number" id="recurring-day" placeholder="Dzień miesiąca (1-31)" required min="1"
                                max="31"
                                class="block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-2">
                        </div>
                        <button type="submit"
                            class="w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700">Dodaj
                            subskrypcję</button>
                    </form>
                </div>
            </div>

            <!-- Stary modal ustawień został usunięty -->

        </main>
    </div>

    <div id="category-details-modal"
        class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="category-details-title" class="text-xl font-semibold text-gray-900 dark:text-white">Szczegóły
                    Kategorii</h3>
                <button id="close-category-details-btn"
                    class="p-2 text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white">&times;</button>
            </div>
            <div class="overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Produkt</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Sklep</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Data</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Cena</th>
                        </tr>
                    </thead>
                    <tbody id="category-details-table-body"
                        class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- Wiersze zostaną wstawione tutaj -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal kopiowania budżetu -->
    <div id="copy-budget-modal"
        class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Kopiuj budżet na następne miesiące</h3>
                <button id="close-copy-budget-modal"
                    class="p-2 text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white">&times;</button>
            </div>
            <div class="space-y-4">
                <p class="text-gray-600 dark:text-gray-300">Na ile miesięcy do przodu chcesz skopiować obecny budżet?
                </p>
                <div class="grid grid-cols-2 gap-3">
                    <button
                        class="copy-months-btn py-3 px-4 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 font-medium"
                        data-months="1">1 miesiąc</button>
                    <button
                        class="copy-months-btn py-3 px-4 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 font-medium"
                        data-months="3">3 miesiące</button>
                    <button
                        class="copy-months-btn py-3 px-4 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 font-medium"
                        data-months="6">6 miesięcy</button>
                    <button
                        class="copy-months-btn py-3 px-4 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 font-medium"
                        data-months="12">12 miesięcy</button>
                </div>
                <div class="flex justify-end space-x-2 pt-4">
                    <button id="cancel-copy-budget"
                        class="py-2 px-4 bg-gray-500 text-white rounded-md hover:bg-gray-600">Anuluj</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Konfiguracja Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyCotoNKJ1Y9BCt6N8ZKCXny9PTcgCJc2fk",
            authDomain: "trackerwydatkowapp.firebaseapp.com",
            projectId: "trackerwydatkowapp",
            storageBucket: "trackerwydatkowapp.firebasestorage.app",
            messagingSenderId: "985262621512",
            appId: "1:985262621512:web:87348caca12ca4c453297d",
            measurementId: "G-SSDG9QGDL4"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Konfiguracja ---
        // Używamy Firebase Functions jako API
        const IS_DEVELOPMENT = false; // Zawsze używamy Firebase Functions
        const API_BASE_URL = ''; // Puste, bo Firebase Hosting automatycznie przekierowuje /api/** do funkcji

        // --- Stan Aplikacji ---
        let allPurchases = [];
        let allCategories = [];
        let allShops = [];
        let editMode = { active: false, purchaseId: null };
        let currentFile = null;
        let cameraStream = null;
        let categoryChart = null;
        let comparisonChart = null;
        let shopChart = null;
        let fp; // Declare fp globally
        let fp_range; // For date range filter

        // --- Elementy DOM ---
        const loadingSection = document.getElementById('loading-section');
        const authSection = document.getElementById('auth-section');
        const appSection = document.getElementById('app-section');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const registerEmail = document.getElementById('register-email');
        const registerPassword = document.getElementById('register-password');
        const authTitle = document.getElementById('auth-title');
        const switchAuthLink = document.getElementById('switch-auth-link');
        const authErrorDiv = document.getElementById('auth-error');

        // Elementy Głównej Aplikacji
        const logoutBtn = document.getElementById('logout-btn');
        const navBtns = document.querySelectorAll('.nav-btn');
        const purchaseForm = document.getElementById('purchase-form');
        const purchaseFormTitle = document.getElementById('purchase-form-title');
        const purchaseFormSubmitBtn = purchaseForm.querySelector('button[type="submit"]');
        const addItemBtn = document.getElementById('add-item-btn');
        const purchasesList = document.getElementById('purchases-list');
        const itemsContainer = document.getElementById('items-container');
        const shopInput = document.getElementById('shop');
        const dateInput = document.getElementById('date');
        const categoriesList = document.getElementById('categories-list');
        const addCategoryForm = document.getElementById('add-category-form');
        const newCategoryInput = document.getElementById('new-category-name');
        const monthlyBalanceValue = document.getElementById('monthly-balance-value');
        const monthlyBalanceLabel = document.getElementById('monthly-balance-label');
        const receiptFileInput = document.getElementById('receipt-file-input');
        const analyzeReceiptBtn = document.getElementById('analyze-receipt-btn');
        const analysisSpinner = document.getElementById('analysis-spinner');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const startCameraBtn = document.getElementById('start-camera-btn');
        const cameraView = document.getElementById('camera-view');
        const cameraStreamEl = document.getElementById('camera-stream');
        const capturePhotoBtn = document.getElementById('capture-photo-btn');
        const cancelCameraBtn = document.getElementById('cancel-camera-btn');
        const purchaseSummary = document.getElementById('purchase-summary');
        const statsTitle = document.getElementById('stats-title');
        const statsMonthSelect = document.getElementById('stats-month-select');
        const categoryChartContainer = document.getElementById('category-chart-container');
        const noDataPieChart = document.getElementById('no-data-pie-chart');
        const comparisonChartContainer = document.getElementById('comparison-chart-container');
        const noDataBarChart = document.getElementById('no-data-bar-chart');
        const shopChartContainer = document.getElementById('shop-chart-container');
        const noDataShopChart = document.getElementById('no-data-shop-chart');
        const categoryDetailsModal = document.getElementById('category-details-modal');
        const closeCategoryDetailsBtn = document.getElementById('close-category-details-btn');
        const categoryDetailsTitle = document.getElementById('category-details-title');
        const categoryDetailsTableBody = document.getElementById('category-details-table-body');
        const quickAddManualBtn = document.getElementById('quick-add-manual-btn');
        const quickAddScanBtn = document.getElementById('quick-add-scan-btn');
        const budgetMonthSelect = document.getElementById('budget-month-select');
        const budgetsList = document.getElementById('budgets-list');
        const saveBudgetBtn = document.getElementById('save-budget-btn');
        const copyBudgetBtn = document.getElementById('copy-budget-btn');
        const copyBudgetModal = document.getElementById('copy-budget-modal');
        const closeCopyBudgetModal = document.getElementById('close-copy-budget-modal');
        const cancelCopyBudget = document.getElementById('cancel-copy-budget');
        const copyMonthsBtns = document.querySelectorAll('.copy-months-btn');

        // Elementy filtrów
        const filterKeyword = document.getElementById('filter-keyword');
        const filterDateRange = document.getElementById('filter-date-range');
        const filterCategory = document.getElementById('filter-category');
        const filterShop = document.getElementById('filter-shop');
        const filterMinAmount = document.getElementById('filter-min-amount');
        const filterMaxAmount = document.getElementById('filter-max-amount');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');
        const filterToggle = document.getElementById('filter-toggle');
        const filtersContainer = document.getElementById('filters-container');
        const filterArrow = document.getElementById('filter-arrow');

        // Elementy wydatków cyklicznych
        const recurringExpensesList = document.getElementById('recurring-expenses-list');
        const addRecurringExpenseForm = document.getElementById('add-recurring-expense-form');
        const recurringName = document.getElementById('recurring-name');
        const recurringAmount = document.getElementById('recurring-amount');
        const recurringCategory = document.getElementById('recurring-category');
        const recurringDay = document.getElementById('recurring-day');

        const shopAutocompleteList = document.getElementById('shop-autocomplete-list');

        // --- Funkcje Pomocnicze ---
        const categoryColors = {};
        const colorPalette = ['#3b82f6', '#10b981', '#ef4444', '#f97316', '#8b5cf6', '#ec4899', '#f59e0b', '#14b8a6', '#64748b', '#06b6d4'];
        let colorIndex = 0;

        function getCategoryColor(category) {
            if (!categoryColors[category]) {
                categoryColors[category] = colorPalette[colorIndex % colorPalette.length];
                colorIndex++;
            }
            return categoryColors[category];
        }

        // --- Autocomplete Functions moved to js/ui.js ---

        function resizeImage(file, maxSize = 1600) {
            return new Promise((resolve, reject) => {
                const image = new Image();
                image.src = URL.createObjectURL(file);
                image.onload = () => {
                    let width = image.width;
                    let height = image.height;

                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(image, 0, 0, width, height);

                    canvas.toBlob(blob => {
                        resolve(new File([blob], file.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        }));
                    }, 'image/jpeg', 0.8); // Kompresja do 80% jakości
                };
                image.onerror = error => reject(error);
            });
        }

        // --- Funkcja kompresji/optymalizacji obrazu ---
        async function resizeImage(file, maxSize = 1920, quality = 0.92) {
            return new Promise((resolve, reject) => {
                const image = new Image();
                image.onload = () => {
                    let { width, height } = image;

                    // Skaluj obraz tylko jeśli jest za duży
                    if (width > maxSize || height > maxSize) {
                        if (width > height) {
                            if (width > maxSize) {
                                height *= maxSize / width;
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width *= maxSize / height;
                                height = maxSize;
                            }
                        }
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');

                    // Popraw jakość renderowania
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';

                    // Zwiększ kontrast dla lepszej czytelności tekstu
                    ctx.filter = 'contrast(1.1) brightness(1.05)';
                    ctx.drawImage(image, 0, 0, width, height);

                    canvas.toBlob(blob => {
                        resolve(new File([blob], file.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        }));
                    }, 'image/jpeg', quality); // Zwiększona jakość z 0.8 do 0.92
                };
                image.onerror = error => reject(error);
                image.src = URL.createObjectURL(file);
            });
        }

        // --- API Functions moved to js/api.js ---

        // --- Authentication Functions moved to js/auth.js ---

        // --- Główna Logika Aplikacji ---
        function setupAppEventListeners() {
            navBtns.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
            purchaseForm.addEventListener('submit', handlePurchaseFormSubmit);
            addItemBtn.addEventListener('click', () => addItemRow());
            itemsContainer.addEventListener('input', (e) => {
                if (e.target.classList.contains('item-price') || e.target.classList.contains('item-name')) {
                    updatePurchaseSummary();
                }
            });
            document.getElementById('cancel-edit-btn').addEventListener('click', () => {
                exitEditMode();
                switchTab('list');
            });

            // Usunięto logikę modala

            addCategoryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newName = newCategoryInput.value.trim().toLowerCase();
                if (newName && !allCategories.includes(newName)) {
                    try {
                        await apiCall('/api/categories', 'POST', { name: newName });
                        newCategoryInput.value = '';
                        // Odśwież wszystko, aby pobrać nową listę kategorii i przerysować interfejs
                        await fetchInitialData(false);
                        renderCategoriesList(); // Odśwież listę w ustawieniach
                        renderBudgetInputs(); // DODANE: Odśwież listę budżetów
                    } catch (error) {
                        alert('Nie udało się dodać kategorii: ' + error.message);
                    }
                } else if (allCategories.includes(newName)) {
                    alert('Taka kategoria już istnieje.');
                }
            });

            purchasesList.addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-purchase-btn');
                if (editBtn) {
                    const purchaseId = e.target.closest('[data-purchase-id]').dataset.purchaseId;
                    enterEditMode(purchaseId);
                    return;
                }

                const deleteBtn = e.target.closest('.delete-purchase-btn');
                if (deleteBtn) {
                    const purchaseId = e.target.closest('[data-purchase-id]').dataset.purchaseId;
                    if (confirm('Czy na pewno chcesz usunąć ten zakup? Operacja jest nieodwracalna.')) {
                        try {
                            await apiCall(`/api/purchases/${purchaseId}`, 'DELETE');
                            await fetchInitialData(false); // nie przełączaj zakładki
                        } catch (error) {
                            alert('Nie udało się usunąć zakupu: ' + error.message);
                        }
                    }
                    return;
                }

                const header = e.target.closest('.purchase-header');
                if (header) {
                    const itemsDiv = header.nextElementSibling;
                    itemsDiv.classList.toggle('hidden');
                    const arrow = header.querySelector('.toggle-arrow');
                    arrow.classList.toggle('rotate-180');
                }
            });

            categoriesList.addEventListener('click', handleCategoryActions);
            analyzeReceiptBtn.addEventListener('click', handleAnalyzeReceipt);
            receiptFileInput.addEventListener('change', handleFileSelect);
            startCameraBtn.addEventListener('click', startCamera);
            cancelCameraBtn.addEventListener('click', stopCamera);
            capturePhotoBtn.addEventListener('click', capturePhoto);
            statsMonthSelect.addEventListener('change', updateCategoryPieChart);

            // Obsługa modala szczegółów kategorii
            closeCategoryDetailsBtn.addEventListener('click', () => categoryDetailsModal.classList.add('hidden'));
            categoryDetailsModal.addEventListener('click', (e) => {
                if (e.target === categoryDetailsModal) {
                    categoryDetailsModal.classList.add('hidden');
                }
            });
            document.getElementById('category-chart').addEventListener('click', handleCategoryChartClick);

            // Szybkie akcje z kokpitu
            quickAddManualBtn.addEventListener('click', () => {
                switchTab('add');
                setTimeout(() => shopInput.focus(), 100);
            });
            quickAddScanBtn.addEventListener('click', () => {
                switchTab('add');
                setTimeout(() => startCamera(), 100);
            });

            // Autouzupełnianie sklepu
            shopInput.addEventListener('input', () => renderShopAutocomplete(shopInput.value));
            shopInput.addEventListener('focus', () => renderShopAutocomplete(shopInput.value));

            shopAutocompleteList.addEventListener('click', (e) => {
                if (e.target.tagName === 'DIV') {
                    shopInput.value = e.target.textContent;
                    shopAutocompleteList.classList.add('hidden');
                }
            });

            // Ukryj autouzupełnianie po kliknięciu gdziekolwiek indziej
            document.addEventListener('click', (e) => {
                if (!shopInput.contains(e.target) && !shopAutocompleteList.contains(e.target)) {
                    shopAutocompleteList.classList.add('hidden');
                }
            });

            // Zarządzanie budżetem
            budgetMonthSelect.addEventListener('change', renderBudgetInputs);
            saveBudgetBtn.addEventListener('click', handleSaveBudget);
            copyBudgetBtn.addEventListener('click', () => copyBudgetModal.classList.remove('hidden'));

            // Modal kopiowania budżetu
            closeCopyBudgetModal.addEventListener('click', () => copyBudgetModal.classList.add('hidden'));
            cancelCopyBudget.addEventListener('click', () => copyBudgetModal.classList.add('hidden'));
            copyBudgetModal.addEventListener('click', (e) => {
                if (e.target === copyBudgetModal) {
                    copyBudgetModal.classList.add('hidden');
                }
            });

            // Przyciski wyboru liczby miesięcy
            copyMonthsBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const monthsCount = parseInt(btn.dataset.months);
                    handleCopyBudget(monthsCount);
                });
            });

            // Logika filtrów
            filterToggle.addEventListener('click', () => {
                filtersContainer.classList.toggle('hidden');
                filterArrow.classList.toggle('rotate-180');
            });

            [filterKeyword, filterCategory, filterShop, filterMinAmount, filterMaxAmount].forEach(el => {
                el.addEventListener('input', () => renderPurchasesList());
            });
            filterDateRange.addEventListener('change', () => renderPurchasesList()); // Flatpickr trigger

            clearFiltersBtn.addEventListener('click', () => {
                filterKeyword.value = '';
                if (fp_range) fp_range.clear();
                filterCategory.value = '';
                filterShop.value = '';
                filterMinAmount.value = '';
                filterMaxAmount.value = '';
                renderPurchasesList();
            });

            // Logika wydatków cyklicznych
            addRecurringExpenseForm.addEventListener('submit', handleAddRecurringExpense);
            recurringExpensesList.addEventListener('click', handleDeleteRecurringExpense);
        }

        // --- Navigation Functions moved to js/ui.js ---

        function populateAllSelects() {
            const categoryOptions = allCategories.map(cat => `<option value="${cat}">${cat.charAt(0).toUpperCase() + cat.slice(1)}</option>`).join('');

            // Filtry
            filterCategory.innerHTML = '<option value="">Wszystkie kategorie</option>' + categoryOptions;

            // Formularz wydatków cyklicznych
            recurringCategory.innerHTML = categoryOptions;

            // Sklepy
            filterShop.innerHTML = '<option value="">Wszystkie sklepy</option>';
            allShops.forEach(shop => {
                const option = document.createElement('option');
                option.value = shop;
                option.textContent = shop;
                filterShop.appendChild(option);
            });
        }

        async function fetchInitialData(shouldSwitchToDefault = true) {
            try {
                [allPurchases, allCategories, allShops] = await Promise.all([
                    apiCall('/api/purchases'),
                    apiCall('/api/categories'),
                    apiCall('/api/shops')
                ]);
                renderAll();
                populateAllSelects();
                populateBudgetMonthSelector(); // Wypełnij selektor miesięcy w budżecie
                if (shouldSwitchToDefault) {
                    switchTab('stats'); // Domyślna zakładka to kokpit
                }
            } catch (error) {
                alert(error.message);
            }
        }

        function renderAll() {
            renderPurchasesList();
            updateMonthlyBalance();
            renderStatistics(); // Od razu renderuj statystyki
        }

        function updateMonthlyBalance() {
            const now = new Date();
            // Użyj roku i miesiąca z `now` do stworzenia daty w lokalnej strefie czasowej, unikając problemów z UTC
            const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const year = firstDayOfMonth.getFullYear();
            const month = (firstDayOfMonth.getMonth() + 1).toString().padStart(2, '0');
            const firstDayOfMonthStr = `${year}-${month}-01`;

            const monthlyPurchases = allPurchases.filter(p => p.date >= firstDayOfMonthStr);
            const total = monthlyPurchases.reduce((sum, p) => sum + (p.totalAmount || 0), 0);
            monthlyBalanceValue.textContent = `${total.toFixed(2)} zł`;

            const monthName = now.toLocaleString('pl-PL', { month: 'long' });
            monthlyBalanceLabel.textContent = `Wydatki w ${monthName.charAt(0).toUpperCase() + monthName.slice(1)}`;
        }

        // --- Logika Formularza Zakupu ---
        function updatePurchaseSummary() {
            const itemPrices = Array.from(document.querySelectorAll('.item-price'));
            const total = itemPrices.reduce((sum, input) => {
                const price = parseFloat(input.value.replace(',', '.')) || 0;
                return sum + price;
            }, 0);
            purchaseSummary.textContent = `Suma: ${total.toFixed(2)} zł`;
        }

        function addItemRow(item = {}) {
            const itemRow = document.createElement('div');
            itemRow.className = 'item-row grid grid-cols-12 gap-2 items-start'; // Zmienione na 12 kolumn dla lepszego układu

            const categoryOptions = allCategories.map(cat => `<option value="${cat}" ${item.category === cat ? 'selected' : ''}>${cat.charAt(0).toUpperCase() + cat.slice(1)}</option>`).join('');

            const priceValue = typeof item.price === 'number' ? item.price.toFixed(2) : '';

            itemRow.innerHTML = `
            <div class="md:col-span-5 col-span-12 break-words">
                <textarea class="item-name mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-3 resize-none overflow-hidden" placeholder="Nazwa produktu" rows="1" required>${item.name || ''}</textarea>
            </div>
            <div class="md:col-span-2 col-span-4">
                <input type="number" step="0.01" class="item-price mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-3" placeholder="Cena" value="${priceValue}" required>
            </div>
            <div class="md:col-span-4 col-span-6">
                <select class="item-category-select mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-3">
                    <option value="">Wybierz kategorię</option>
                    ${categoryOptions}
                    <option value="__add_new__">-- Dodaj nową --</option>
                </select>
                <input type="text" class="new-category-input hidden mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-3" placeholder="Nazwa nowej kategorii">
            </div>
            <div class="md:col-span-1 col-span-2 text-right flex items-start justify-end">
                <button type="button" class="remove-item-btn p-3 text-red-500 hover:text-red-700 rounded-full mt-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg></button>
            </div>
        `;
            itemsContainer.appendChild(itemRow);

            const itemNameInput = itemRow.querySelector('.item-name');
            const categorySelect = itemRow.querySelector('.item-category-select');
            const newCategoryInput = itemRow.querySelector('.new-category-input');

            // Automatyczne dopasowanie wysokości pola textarea
            function autoResizeTextarea() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            }
            itemNameInput.addEventListener('input', autoResizeTextarea, false);
            // Ustawienie początkowej wysokości (ważne przy edycji)
            setTimeout(() => autoResizeTextarea.call(itemNameInput), 0);

            categorySelect.addEventListener('change', () => {
                if (categorySelect.value === '__add_new__') {
                    categorySelect.classList.add('hidden');
                    newCategoryInput.classList.remove('hidden');
                    newCategoryInput.focus();
                }
            });

            newCategoryInput.addEventListener('blur', () => handleNewCategory(newCategoryInput, categorySelect));
            newCategoryInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleNewCategory(newCategoryInput, categorySelect);
                }
            });

            itemRow.querySelector('.remove-item-btn').addEventListener('click', () => {
                itemRow.remove();
                updatePurchaseSummary();
            });

            updatePurchaseSummary();
        }

        function handleNewCategory(newCategoryInput, categorySelect) {
            const newCategory = newCategoryInput.value.trim().toLowerCase();
            newCategoryInput.value = '';
            newCategoryInput.classList.add('hidden');
            categorySelect.classList.remove('hidden');

            if (newCategory && !allCategories.includes(newCategory)) {
                allCategories.push(newCategory);
                allCategories.sort();
                updateAllCategorySelects(newCategory, categorySelect);
                // Kategoria zostanie ustawiona w updateAllCategorySelects
            } else if (newCategory && allCategories.includes(newCategory)) {
                // Jeśli kategoria już istnieje, ustaw ją
                categorySelect.value = newCategory;
            } else {
                // Jeśli nie ma kategorii, wyczyść select
                categorySelect.value = '';
            }
        }

        function updateAllCategorySelects(newlySelected = null, targetSelect = null) {
            const categoryOptions = allCategories.map(cat => `<option value="${cat}">${cat.charAt(0).toUpperCase() + cat.slice(1)}</option>`).join('');
            const fullHtml = `<option value="">Wybierz kategorię</option>${categoryOptions}<option value="__add_new__">-- Dodaj nową --</option>`;

            document.querySelectorAll('.item-category-select').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = fullHtml;

                // Ustaw nową kategorię tylko w tym konkretnym select, który ją dodał
                if (targetSelect && select === targetSelect && newlySelected) {
                    select.value = newlySelected;
                } else {
                    select.value = currentValue;
                }
            });
        }

        async function handlePurchaseFormSubmit(e) {
            e.preventDefault();
            const purchaseData = {
                shop: shopInput.value,
                date: dateInput.value,
                items: Array.from(document.querySelectorAll('.item-row')).map(row => {
                    const name = row.querySelector('.item-name').value;
                    const price = parseFloat(row.querySelector('.item-price').value.replace(',', '.'));
                    let category = row.querySelector('.item-category-select').value;
                    if (!category || category === '__add_new__') category = 'inne';
                    return { name, price, category };
                }).filter(item => item.name && !isNaN(item.price))
            };

            if (purchaseData.items.length === 0) {
                alert('Dodaj przynajmniej jedną pozycję do zakupu.');
                return;
            }

            try {
                if (editMode.active) {
                    await apiCall(`/api/purchases/${editMode.purchaseId}`, 'PUT', purchaseData);
                } else {
                    await apiCall('/api/purchases', 'POST', purchaseData);
                }
                await fetchInitialData(false);
                switchTab('list');
            } catch (error) {
                alert('Błąd zapisu: ' + error.message);
            }
        }

        // --- Edit Mode Functions moved to js/ui.js ---

        // --- Logika Listy Zakupów ---
        function applyFilters() {
            const keyword = filterKeyword.value.toLowerCase();
            const category = filterCategory.value;
            const shop = filterShop.value;
            const minAmount = parseFloat(filterMinAmount.value) || 0;
            const maxAmount = parseFloat(filterMaxAmount.value) || Infinity;
            const dateRange = fp_range.selectedDates;

            let filtered = allPurchases;

            // 1. Filtrowanie po dacie zakupu (poprawione, aby uwzględniać cały dzień)
            if (dateRange.length === 2) {
                const startDate = dateRange[0];
                const endDate = new Date(dateRange[1]); // Utwórz kopię, aby nie modyfikować oryginału
                endDate.setHours(23, 59, 59, 999); // Ustaw czas na koniec dnia dla pełnej inkluzywności

                filtered = filtered.filter(p => {
                    // Parsuj datę zakupu jako lokalną, aby uniknąć problemów ze strefą czasową
                    const parts = p.date.split('-').map(Number);
                    const purchaseDate = new Date(parts[0], parts[1] - 1, parts[2]);
                    return purchaseDate >= startDate && purchaseDate <= endDate;
                });
            }

            // 2. Filtrowanie po sklepie i kwocie całego zakupu
            if (shop) filtered = filtered.filter(p => p.shop === shop);
            filtered = filtered.filter(p => p.totalAmount >= minAmount && p.totalAmount <= maxAmount);

            // 3. Filtrowanie po produktach (słowo kluczowe, kategoria)
            if (keyword || category) {
                filtered = filtered.map(p => {
                    const matchingItems = p.items.filter(item => {
                        const keywordMatch = !keyword || item.name.toLowerCase().includes(keyword);
                        const categoryMatch = !category || item.category === category;
                        return keywordMatch && categoryMatch;
                    });

                    if (matchingItems.length > 0) {
                        // Zwróć kopię zakupu tylko z pasującymi produktami
                        return { ...p, items: matchingItems };
                    }
                    return null;
                }).filter(p => p !== null); // Usuń zakupy, które nie mają pasujących produktów
            }

            return filtered;
        }

        function renderPurchasesList() {
            const filteredPurchases = applyFilters();
            if (filteredPurchases.length === 0) {
                purchasesList.innerHTML = '<div class="text-center py-12"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg><h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">Brak zakupów</h3><p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Zacznij dodawać wydatki, aby zobaczyć je tutaj.</p></div>';
                return;
            }
            purchasesList.innerHTML = filteredPurchases.map(p => `
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm" data-purchase-id="${p.id}">
                <div class="purchase-header flex justify-between items-center p-4 cursor-pointer">
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0 h-10 w-10 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                        </div>
                        <div>
                            <p class="font-bold text-lg text-gray-900 dark:text-white">${p.shop}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${p.date}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <p class="font-bold text-xl text-gray-900 dark:text-white whitespace-nowrap">${(p.totalAmount || 0).toFixed(2)} zł</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${(p.items || []).length} poz.</p>
                        </div>
                        <div class="flex items-center">
                            <button class="edit-purchase-btn p-2 text-blue-500 hover:text-blue-700" title="Edytuj"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                            <button class="delete-purchase-btn p-2 text-red-500 hover:text-red-700" title="Usuń"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 toggle-arrow text-gray-500 dark:text-gray-400 transition-transform transform" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </div>
                    </div>
                </div>
                <div class="purchase-items hidden border-t border-gray-200 dark:border-gray-700 p-4 space-y-2">
                    ${(p.items || []).map(item => `
                        <div class="flex justify-between items-center">
                            <span class="text-gray-800 dark:text-gray-200 break-words">${item.name}</span>
                            <div class="flex items-center space-x-2 flex-shrink-0">
                                <span class="category-tag text-white text-xs font-semibold" style="background-color: ${getCategoryColor(item.category)}; padding: 3px 10px; border-radius: 9999px;">${item.category}</span>
                                 <span class="font-medium text-gray-900 dark:text-white whitespace-nowrap">${(item.price || 0).toFixed(2)}&nbsp;zł</span>
                            </div>


                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
        }

        // --- Logika Zarządzania Kategoriami ---
        function renderCategoriesList() {
            categoriesList.innerHTML = allCategories.map(cat => `
            <div class="flex justify-between items-center p-2 border-b border-gray-200 dark:border-gray-700" data-category-name="${cat}">
                <span class="category-text text-gray-900 dark:text-white">${cat.charAt(0).toUpperCase() + cat.slice(1)}</span>
                <div class="category-actions">
                    <button class="rename-cat-btn p-1 text-blue-500 hover:text-blue-700" title="Zmień nazwę"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                    <button class="delete-cat-btn p-1 text-red-500 hover:text-red-700" title="Usuń"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                </div>
            </div>
        `).join('');
        }

        async function handleCategoryActions(e) {
            const renameBtn = e.target.closest('.rename-cat-btn');
            if (renameBtn) {
                const categoryDiv = e.target.closest('[data-category-name]');
                const oldName = categoryDiv.dataset.categoryName;
                const newName = prompt(`Wprowadź nową nazwę dla kategorii "${oldName}":`, oldName);
                if (newName && newName.trim() !== '' && newName !== oldName) {
                    try {
                        await apiCall(`/api/categories/${oldName}`, 'PUT', { newName: newName.trim().toLowerCase() });
                        await fetchInitialData(false);
                        renderCategoriesList();
                        renderBudgetInputs(); // DODANE
                    } catch (error) {
                        alert('Nie udało się zmienić nazwy: ' + error.message);
                    }
                }
            }

            const deleteBtn = e.target.closest('.delete-cat-btn');
            if (deleteBtn) {
                const categoryDiv = e.target.closest('[data-category-name]');
                const name = categoryDiv.dataset.categoryName;
                if (confirm(`Czy na pewno chcesz usunąć kategorię "${name}"? Wszystkie produkty z tą kategorią zostaną oznaczone jako "inne".`)) {
                    try {
                        await apiCall(`/api/categories/${name}`, 'DELETE');
                        await fetchInitialData(false);
                        renderCategoriesList();
                        renderBudgetInputs(); // DODANE
                    } catch (error) {
                        alert('Nie udało się usunąć kategorii: ' + error.message);
                    }
                }
            }
        }

        // --- Logika Skanowania i Aparatu ---
        // --- File Handling Functions moved to js/ui.js ---

        async function handleAnalyzeReceipt() {
            if (!currentFile) {
                alert('Najpierw wybierz plik z paragonem.');
                return;
            }
            analysisSpinner.classList.remove('hidden');
            analyzeReceiptBtn.disabled = true;
            imagePreviewContainer.classList.add('hidden');
            try {
                let fileToSend = currentFile;
                if (currentFile.type.startsWith('image/')) {
                    fileToSend = await resizeImage(currentFile);
                }
                const { analysis } = await apiCallWithFile('/api/analyze-receipt', fileToSend);
                await fillFormWithAnalysis(analysis);
            } catch (error) {
                alert('Błąd analizy paragonu: ' + error.message);
            } finally {
                analysisSpinner.classList.add('hidden');
                analyzeReceiptBtn.disabled = false;
                receiptFileInput.value = '';
                currentFile = null;
            }
        }

        // --- Camera Functions moved to js/ui.js ---

        async function fillFormWithAnalysis(analysis) {
            shopInput.value = analysis.shop || '';
            dateInput.value = analysis.date || new Date().toISOString().split('T')[0];
            itemsContainer.innerHTML = '';

            // Obsługa konwersji waluty
            if (analysis.originalCurrency && analysis.originalCurrency !== 'PLN') {
                const rate = analysis.exchangeRate ? analysis.exchangeRate.toFixed(4) : 'nieznany';
                const itemCount = (analysis.items || []).length;
                const originalTotal = (analysis.items || []).reduce((sum, item) => sum + (item.price / analysis.exchangeRate), 0);
                const convertedTotal = (analysis.items || []).reduce((sum, item) => sum + item.price, 0);

                // Sprawdź czy kurs został pobrany pomyślnie
                if (analysis.rateSuccess === false) {
                    // Nie udało się pobrać kursu - zaproponuj ręczne wprowadzenie
                    const userRate = prompt(
                        `⚠️ Nie udało się automatycznie pobrać kursu wymiany dla ${analysis.originalCurrency}!\n\n` +
                        `Wykryto ${itemCount} produktów w walucie ${analysis.originalCurrency}.\n` +
                        `Suma oryginalna: ${originalTotal.toFixed(2)} ${analysis.originalCurrency}\n\n` +
                        `Wprowadź kurs wymiany ręcznie:\n` +
                        `1 ${analysis.originalCurrency} = ? PLN`,
                        '1.0'
                    );

                    if (userRate && !isNaN(parseFloat(userRate)) && parseFloat(userRate) > 0) {
                        try {
                            // Wywołaj endpoint do ręcznego przeliczenia
                            const originalItems = (analysis.items || []).map(item => ({
                                ...item,
                                price: item.price / analysis.exchangeRate // Przywróć oryginalną cenę
                            }));

                            const conversionResult = await apiCall('/api/convert-currency', 'POST', {
                                items: originalItems,
                                fromCurrency: analysis.originalCurrency,
                                exchangeRate: parseFloat(userRate)
                            });

                            // Zaktualizuj analizę z nowym kursem
                            analysis.items = conversionResult.items;
                            analysis.exchangeRate = conversionResult.exchangeRate;
                            analysis.rateSuccess = true;

                            const newConvertedTotal = conversionResult.items.reduce((sum, item) => sum + item.price, 0);

                            alert(
                                `✅ Kurs został zaktualizowany!\n\n` +
                                `📊 Szczegóły przeliczenia:\n` +
                                `• Waluta oryginalna: ${analysis.originalCurrency}\n` +
                                `• Kurs wymiany: 1 ${analysis.originalCurrency} = ${userRate} PLN\n` +
                                `• Liczba produktów: ${itemCount}\n` +
                                `• Suma oryginalna: ${originalTotal.toFixed(2)} ${analysis.originalCurrency}\n` +
                                `• Suma po przeliczeniu: ${newConvertedTotal.toFixed(2)} PLN\n\n` +
                                `✅ Wszystkie ceny zostały przeliczone z nowym kursem.`
                            );
                        } catch (error) {
                            alert('Błąd podczas przeliczania kursu: ' + error.message);
                            return;
                        }
                    } else {
                        alert('Anulowano przeliczenie. Produkty pozostaną w oryginalnej walucie.');
                    }
                } else {
                    // Kurs został pobrany pomyślnie - pokaż standardowy komunikat
                    const message = `💱 Wykryto paragon w walucie ${analysis.originalCurrency}!\n\n` +
                        `📊 Szczegóły przeliczenia:\n` +
                        `• Waluta oryginalna: ${analysis.originalCurrency}\n` +
                        `• Kurs wymiany: 1 ${analysis.originalCurrency} = ${rate} PLN\n` +
                        `• Liczba produktów: ${itemCount}\n` +
                        `• Suma oryginalna: ${originalTotal.toFixed(2)} ${analysis.originalCurrency}\n` +
                        `• Suma po przeliczeniu: ${convertedTotal.toFixed(2)} PLN\n\n` +
                        `✅ Wszystkie ceny zostały automatycznie przeliczone na PLN.`;

                    alert(message);
                }
            }

            const processedItems = (analysis.items || []).map(item => {
                const rawPrice = item.price ? item.price.toString().replace(',', '.') : '0';
                const parsedPrice = parseFloat(rawPrice);
                return {
                    ...item,
                    price: isNaN(parsedPrice) ? 0 : parseFloat(parsedPrice.toFixed(2))
                };
            });

            processedItems.forEach(item => {
                if (item.category && !allCategories.includes(item.category)) {
                    allCategories.push(item.category);
                    allCategories.sort();
                }
                addItemRow(item);
            });

            if (processedItems.length === 0) {
                addItemRow();
            }
            updateAllCategorySelects();
            updatePurchaseSummary();
            alert('Formularz został wypełniony danymi z paragonu. Sprawdź dane przed zapisem.');
        }

        // --- Logika Statystyk ---
        async function renderStatistics() {
            try {
                const initialStats = await apiCall('/api/statistics');
                populateMonthSelector(initialStats.availableMonths);
                await updateCategoryPieChart();
                await renderComparisonBarChart();
                await renderShopBarChart(); // Dodane wywołanie
            } catch (error) {
                console.error("Błąd ładowania statystyk:", error);
            }
        }

        function populateMonthSelector(availableMonths) {
            statsMonthSelect.innerHTML = '';
            if (!availableMonths || availableMonths.length === 0) {
                statsMonthSelect.innerHTML = '<option>Brak danych</option>';
                return;
            }
            availableMonths.forEach(monthStr => {
                const option = document.createElement('option');
                option.value = monthStr;
                const [y, m] = monthStr.split('-');
                option.textContent = new Date(y, m - 1).toLocaleString('pl-PL', { month: 'long', year: 'numeric' });
                statsMonthSelect.appendChild(option);
            });
        }

        async function updateCategoryPieChart() {
            const selectedMonth = statsMonthSelect.value;
            if (!selectedMonth || selectedMonth === 'Brak danych') {
                noDataPieChart.classList.remove('hidden');
                categoryChartContainer.classList.add('hidden');
                document.getElementById('budget-progress-container').innerHTML = ''; // Wyczyść paski postępu
                document.getElementById('budget-summary-container').classList.add('hidden'); // Ukryj podsumowanie
                return;
            };

            const [year, month] = selectedMonth.split('-');

            // Pobierz jednocześnie statystyki wydatków i dane budżetu
            const [stats, budgetData] = await Promise.all([
                apiCall(`/api/statistics?year=${year}&month=${month}`),
                apiCall(`/api/budgets/${year}/${month}`)
            ]);

            const spendingByCategory = stats.spendingByCategory;
            const budgets = budgetData.budgets || {};

            // Renderuj paski postępu budżetu i podsumowanie
            renderBudgetProgress(spendingByCategory, budgets);
            renderBudgetSummary(spendingByCategory, budgets);

            const ctx = document.getElementById('category-chart').getContext('2d');
            const labels = Object.keys(spendingByCategory);
            const data = Object.values(spendingByCategory);
            const backgroundColors = labels.map(label => getCategoryColor(label));

            if (categoryChart) categoryChart.destroy();

            if (labels.length === 0) {
                noDataPieChart.classList.remove('hidden');
                categoryChartContainer.classList.add('hidden');
            } else {
                noDataPieChart.classList.add('hidden');
                categoryChartContainer.classList.remove('hidden');
                categoryChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                        datasets: [{ data, backgroundColor: backgroundColors }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    boxWidth: 12,
                                    padding: 15,
                                    color: 'white'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += new Intl.NumberFormat('pl-PL', { style: 'currency', currency: 'PLN' }).format(context.parsed);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            // Po zmianie miesiąca, zaktualizuj też wykres sklepów
            await renderShopBarChart();
        }

        function renderBudgetProgress(spending, budgets) {
            const container = document.getElementById('budget-progress-container');
            container.innerHTML = ''; // Wyczyść poprzednie paski

            const categoriesWithBudget = Object.keys(budgets);

            if (categoriesWithBudget.length === 0) {
                container.innerHTML = '<p class="text-center text-sm text-gray-500 dark:text-gray-400">Nie zdefiniowano budżetu na ten miesiąc.</p>';
                return;
            }

            categoriesWithBudget.forEach(cat => {
                const budgetAmount = budgets[cat];
                const spentAmount = spending[cat] || 0;
                const percentage = Math.min((spentAmount / budgetAmount) * 100, 100);

                const categoryColor = getCategoryColor(cat);
                let warningIcon = '';
                let amountClass = 'text-gray-600 dark:text-gray-400';

                if (spentAmount > budgetAmount) {
                    warningIcon = '<span class="text-red-500 ml-2">⚠️</span>';
                    amountClass = 'text-red-500 font-semibold';
                }

                const progressElement = document.createElement('div');
                progressElement.innerHTML = `
                <div class="flex justify-between items-center text-sm mb-1">
                    <span class="font-medium text-gray-800 dark:text-gray-200 flex items-center">${cat.charAt(0).toUpperCase() + cat.slice(1)} ${warningIcon}</span>
                    <span class="${amountClass}">${spentAmount.toFixed(2)} zł / ${budgetAmount.toFixed(2)} zł</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                    <div class="h-2.5 rounded-full" style="width: ${percentage}%; background-color: ${categoryColor};"></div>
                </div>
            `;
                container.appendChild(progressElement);
            });
        }

        function renderBudgetSummary(spending, budgets) {
            const summaryContainer = document.getElementById('budget-summary-container');
            const totalBudgetEl = document.getElementById('total-budget');
            const totalSpentEl = document.getElementById('total-spent');
            const totalRemainingEl = document.getElementById('total-remaining');
            const unbudgetedExpensesEl = document.getElementById('unbudgeted-expenses');
            const unbudgetedAmountEl = document.getElementById('unbudgeted-amount');
            const unbudgetedCategoriesEl = document.getElementById('unbudgeted-categories');

            // Oblicz sumy
            const totalBudget = Object.values(budgets).reduce((sum, amount) => sum + amount, 0);
            const totalSpentInBudget = Object.keys(budgets).reduce((sum, cat) => sum + (spending[cat] || 0), 0);
            const totalSpent = Object.values(spending).reduce((sum, amount) => sum + amount, 0);
            const totalRemaining = totalBudget - totalSpentInBudget;

            // Znajdź wydatki bez budżetu
            const unbudgetedCategories = Object.keys(spending).filter(cat => !budgets[cat]);
            const unbudgetedAmount = unbudgetedCategories.reduce((sum, cat) => sum + spending[cat], 0);

            // Aktualizuj wartości
            totalBudgetEl.textContent = `${totalBudget.toFixed(2)} zł`;
            totalSpentEl.textContent = `${totalSpent.toFixed(2)} zł`;

            // Kolor dla pozostałej kwoty
            if (totalRemaining >= 0) {
                totalRemainingEl.textContent = `${totalRemaining.toFixed(2)} zł`;
                totalRemainingEl.className = 'text-lg font-bold text-green-600 dark:text-green-400';
            } else {
                totalRemainingEl.textContent = `${Math.abs(totalRemaining).toFixed(2)} zł przekroczono`;
                totalRemainingEl.className = 'text-lg font-bold text-red-600 dark:text-red-400';
            }

            // Pokaż/ukryj wydatki bez budżetu
            if (unbudgetedAmount > 0) {
                unbudgetedAmountEl.textContent = `${unbudgetedAmount.toFixed(2)} zł`;
                unbudgetedCategoriesEl.textContent = `Kategorie: ${unbudgetedCategories.map(cat => cat.charAt(0).toUpperCase() + cat.slice(1)).join(', ')}`;
                unbudgetedExpensesEl.classList.remove('hidden');
            } else {
                unbudgetedExpensesEl.classList.add('hidden');
            }

            // Pokaż podsumowanie tylko jeśli jest budżet
            if (totalBudget > 0 || unbudgetedAmount > 0) {
                summaryContainer.classList.remove('hidden');
            } else {
                summaryContainer.classList.add('hidden');
            }
        }

        async function handleCategoryChartClick(event) {
            if (!categoryChart) return;
            const points = categoryChart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);

            if (points.length) {
                const firstPoint = points[0];
                const label = categoryChart.data.labels[firstPoint.index].toLowerCase();
                const selectedMonth = statsMonthSelect.value;
                const [year, month] = selectedMonth.split('-');

                try {
                    const { items } = await apiCall(`/api/statistics/category-details?year=${year}&month=${month}&category=${label}`);
                    renderCategoryDetailsModal(label, items);
                } catch (error) {
                    alert('Błąd pobierania szczegółów kategorii: ' + error.message);
                }
            }
        }

        // --- Modal Functions moved to js/ui.js ---

        async function renderComparisonBarChart() {
            const stats = await apiCall('/api/statistics/comparison');
            const ctx = document.getElementById('comparison-chart').getContext('2d');

            if (comparisonChart) comparisonChart.destroy();

            if (!stats.monthlyTotals || stats.monthlyTotals.length === 0) {
                noDataBarChart.classList.remove('hidden');
                comparisonChartContainer.classList.add('hidden');
            } else {
                noDataBarChart.classList.add('hidden');
                comparisonChartContainer.classList.remove('hidden');
                const labels = stats.monthlyTotals.map(item => {
                    const [y, m] = item.month.split('-');
                    return new Date(y, m - 1).toLocaleString('pl-PL', { month: 'short', year: 'numeric' });
                });
                const data = stats.monthlyTotals.map(item => item.total);

                comparisonChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Suma wydatków',
                            data,
                            backgroundColor: '#3B82F6'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                ticks: { color: 'white' },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            x: {
                                ticks: { color: 'white' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
            }
        }

        async function renderShopBarChart() {
            const selectedMonth = statsMonthSelect.value;
            if (!selectedMonth || selectedMonth === 'Brak danych') {
                noDataShopChart.classList.remove('hidden');
                shopChartContainer.classList.add('hidden');
                return;
            };

            const [year, month] = selectedMonth.split('-');
            const stats = await apiCall(`/api/statistics/by-shop?year=${year}&month=${month}`);
            const ctx = document.getElementById('shop-chart').getContext('2d');

            if (shopChart) shopChart.destroy();

            const labels = Object.keys(stats.spendingByShop);
            const data = Object.values(stats.spendingByShop);

            if (labels.length === 0) {
                noDataShopChart.classList.remove('hidden');
                shopChartContainer.classList.add('hidden');
            } else {
                noDataShopChart.classList.add('hidden');
                shopChartContainer.classList.remove('hidden');

                // Dynamiczne ustawianie wysokości kontenera wykresu
                const barHeight = 25; // Wysokość jednego słupka w pikselach
                const chartHeight = labels.length * barHeight;
                shopChartContainer.style.height = `${Math.max(chartHeight, 200)}px`; // Minimalna wysokość 200px

                shopChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Wydatki w sklepie',
                            data,
                            backgroundColor: colorPalette
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // Pozwala na niestandardowe wymiary
                        plugins: { legend: { display: false } },
                        indexAxis: 'y', // Wykres horyzontalny dla lepszej czytelności nazw sklepów
                        scales: {
                            y: {
                                ticks: {
                                    color: 'white',
                                    autoSkip: false // Wyświetla wszystkie etykiety
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            x: {
                                ticks: { color: 'white' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
            }
        }

        // --- Logika Budżetowania ---
        function populateBudgetMonthSelector() {
            budgetMonthSelect.innerHTML = '';
            const months = [];
            const today = new Date();
            const currentMonthStr = today.toISOString().substring(0, 7);

            // Generuj listę miesięcy: 2 poprzednie, bieżący i 12 przyszłych
            for (let i = -2; i <= 12; i++) {
                const d = new Date(today.getFullYear(), today.getMonth() + i, 1);
                months.push(d.toISOString().substring(0, 7));
            }

            // Sortuj od najnowszego do najstarszego
            months.sort().reverse();

            months.forEach(monthStr => {
                const option = document.createElement('option');
                option.value = monthStr;
                const [y, m] = monthStr.split('-');
                option.textContent = new Date(y, m - 1).toLocaleString('pl-PL', { month: 'long', year: 'numeric' });

                // Ustaw bieżący miesiąc jako domyślnie wybrany
                if (monthStr === currentMonthStr) {
                    option.selected = true;
                }

                budgetMonthSelect.appendChild(option);
            });
        }

        async function renderBudgetInputs() {
            if (!budgetMonthSelect.value) {
                console.warn("budgetMonthSelect.value jest puste, pomijam renderowanie budżetu");
                return;
            }

            const [year, month] = budgetMonthSelect.value.split('-');
            if (!year || !month) {
                console.error("Nieprawidłowy format daty:", budgetMonthSelect.value);
                return;
            }

            try {
                const { budgets } = await apiCall(`/api/budgets/${year}/${month}`);
                budgetsList.innerHTML = allCategories.map(cat => `
                <div class="flex justify-between items-center">
                    <label for="budget-${cat}" class="text-gray-800 dark:text-gray-200">${cat.charAt(0).toUpperCase() + cat.slice(1)}</label>
                    <input type="number" id="budget-${cat}" data-category="${cat}"
                           class="budget-input w-32 rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm py-1"
                           placeholder="0.00" value="${budgets[cat] || ''}">
                </div>
            `).join('');
            } catch (error) {
                console.error("Błąd renderowania pól budżetu:", error);
                budgetsList.innerHTML = `<p class="text-red-500">Nie udało się załadować danych budżetu.</p>`;
            }
        }

        async function handleSaveBudget() {
            const [year, month] = budgetMonthSelect.value.split('-');
            const budgetInputs = budgetsList.querySelectorAll('.budget-input');
            const budgets = {};

            budgetInputs.forEach(input => {
                const category = input.dataset.category;
                const amount = parseFloat(input.value);
                if (amount > 0) {
                    budgets[category] = amount;
                }
            });

            try {
                await apiCall(`/api/budgets/${year}/${month}`, 'POST', { budgets });
                alert('Budżet został pomyślnie zapisany!');
                // Odśwież statystyki, jeśli widok kokpitu jest aktywny
                if (document.getElementById('stats-tab').classList.contains('active')) {
                    renderStatistics();
                }
            } catch (error) {
                alert('Nie udało się zapisać budżetu: ' + error.message);
            }
        }

        async function handleCopyBudget(monthsCount) {
            const [currentYear, currentMonth] = budgetMonthSelect.value.split('-');
            const budgetInputs = budgetsList.querySelectorAll('.budget-input');
            const budgets = {};

            // Pobierz obecny budżet
            budgetInputs.forEach(input => {
                const category = input.dataset.category;
                const amount = parseFloat(input.value);
                if (amount > 0) {
                    budgets[category] = amount;
                }
            });

            if (Object.keys(budgets).length === 0) {
                alert('Brak budżetu do skopiowania. Najpierw ustaw budżet dla obecnego miesiąca.');
                return;
            }

            try {
                // Zapisz budżet na następne miesiące
                const promises = [];
                for (let i = 1; i <= monthsCount; i++) {
                    const targetDate = new Date(currentYear, currentMonth - 1 + i, 1);
                    const targetYear = targetDate.getFullYear();
                    const targetMonth = String(targetDate.getMonth() + 1).padStart(2, '0');

                    promises.push(
                        apiCall(`/api/budgets/${targetYear}/${targetMonth}`, 'POST', { budgets })
                    );
                }

                await Promise.all(promises);

                const monthText = monthsCount === 1 ? '1 miesiąc' : `${monthsCount} miesięcy`;
                alert(`✅ Budżet został skopiowany na następne ${monthText}!`);

                // Zamknij modal
                copyBudgetModal.classList.add('hidden');

            } catch (error) {
                alert('Błąd podczas kopiowania budżetu: ' + error.message);
            }
        }

        // --- Logika Wydatków Cyklicznych ---
        async function renderRecurringExpenses() {
            try {
                const expenses = await apiCall('/api/recurring-expenses');
                recurringExpensesList.innerHTML = expenses.map(exp => `
                <div class="flex justify-between items-center p-2 border-b border-gray-200 dark:border-gray-700">
                    <div>
                        <p class="font-semibold text-gray-900 dark:text-white">${exp.name}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${exp.amount.toFixed(2)} zł, kategoria: ${exp.category}, dzień: ${exp.dayOfMonth}</p>
                    </div>
                    <button data-id="${exp.id}" class="delete-recurring-btn p-1 text-red-500 hover:text-red-700" title="Usuń">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            `).join('');
            } catch (error) {
                recurringExpensesList.innerHTML = `<p class="text-red-500">Nie udało się załadować wydatków cyklicznych.</p>`;
            }
        }

        async function handleAddRecurringExpense(e) {
            e.preventDefault();
            const data = {
                name: recurringName.value,
                amount: recurringAmount.value,
                category: recurringCategory.value,
                dayOfMonth: recurringDay.value
            };

            try {
                await apiCall('/api/recurring-expenses', 'POST', data);
                addRecurringExpenseForm.reset();
                renderRecurringExpenses();
            } catch (error) {
                alert('Błąd dodawania wydatku: ' + error.message);
            }
        }

        async function handleDeleteRecurringExpense(e) {
            const deleteBtn = e.target.closest('.delete-recurring-btn');
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                if (confirm('Czy na pewno chcesz usunąć ten wydatek cykliczny?')) {
                    try {
                        await apiCall(`/api/recurring-expenses/${id}`, 'DELETE');
                        renderRecurringExpenses();
                    } catch (error) {
                        alert('Błąd usuwania wydatku: ' + error.message);
                    }
                }
            }
        }

        // --- Inicjalizacja Aplikacji ---
        async function initializeApp() {
            setupAppEventListeners();
            // Dodaj małe opóźnienie, żeby token Firebase Auth był gotowy
            await new Promise(resolve => setTimeout(resolve, 100));
            await fetchInitialData();
            exitEditMode();
        }

        // Główny mechanizm obsługi stanu uwierzytelnienia
        auth.onAuthStateChanged(user => {
            loadingSection.classList.add('hidden');
            if (user) {
                // Użytkownik jest zalogowany
                authSection.classList.add('hidden');
                appSection.classList.remove('hidden');
                initializeApp();
            } else {
                // Użytkownik jest wylogowany
                authSection.classList.remove('hidden');
                appSection.classList.add('hidden');
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = null;
                }
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            setupAuthEventListeners();
            // Usunięto wywołanie main() - teraz onAuthStateChanged zarządza stanem

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker zarejestrowany:', reg))
                    .catch(err => console.log('Błąd rejestracji Service Workera:', err));
            }

            // Initialize Flatpickr and store the instance
            fp = flatpickr("#date", {
                dateFormat: "Y-m-d",
                defaultDate: new Date(),
                altInput: true,
                altFormat: "d.m.Y", // Polski format: "02.08.2025"
                theme: "dark",
                locale: "pl", // Polska lokalizacja
                allowInput: true // Pozwala na ręczne wpisywanie daty
            });

            fp_range = flatpickr("#filter-date-range", {
                mode: "range",
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "d.m.Y", // Polski format: "02.08.2025"
                theme: "dark",
                locale: "pl", // Polska lokalizacja
                allowInput: true // Pozwala na ręczne wpisywanie daty
            });
        });
    </script>
    <script src="js/ui.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pl.js"></script>
</body>

</html>